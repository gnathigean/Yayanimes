<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anime - YayaAnimes</title>
    <link rel="stylesheet" href="streaming.css" />
    <style>
      .anime-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #0a0a0a;
        min-height: 100vh;
      }

      .back-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .anime-header {
        display: flex;
        gap: 30px;
        background: #1a1a1a;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
      }

      .anime-poster {
        flex-shrink: 0;
      }

      .anime-poster img {
        width: 250px;
        height: 350px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(255, 107, 107, 0.3);
      }

      .anime-details {
        flex: 1;
        color: white;
      }

      .anime-title {
        font-size: 32px;
        margin-bottom: 15px;
        color: #ff6b6b;
      }

      .anime-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .meta-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
      }

      .anime-description {
        line-height: 1.8;
        color: #ccc;
        margin-bottom: 20px;
      }

      .anime-genres {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .genre-tag {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
      }

      .episodes-section {
        background: #1a1a1a;
        padding: 30px;
        border-radius: 12px;
      }

      .episodes-section h2 {
        color: white;
        margin-bottom: 20px;
        font-size: 24px;
      }

      .episodes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
      }

      .episode-card {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 10px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
      }

      .episode-card:hover {
        background: #3a3a3a;
        border-color: #ff6b6b;
        transform: translateY(-4px);
      }

      .episode-number {
        font-size: 18px;
        font-weight: 700;
        color: white;
        margin-bottom: 5px;
      }

      .episode-title {
        font-size: 12px;
        color: #888;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: #ccc;
      }

      .loading-state .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 107, 107, 0.2);
        border-top-color: #ff6b6b;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .anime-header {
          flex-direction: column;
          align-items: center;
        }

        .anime-poster img {
          width: 200px;
          height: 280px;
        }

        .anime-title {
          font-size: 24px;
          text-align: center;
        }

        .episodes-grid {
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="anime-container">
      <button class="back-btn" onclick="window.history.back()">‚Üê Voltar</button>

      <div id="anime-content">
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Carregando detalhes...</p>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="api-service.js"></script>
    <script>
      let currentAnimeId = null;
      let animeData = null;

      // Pega par√¢metros da URL
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id"),
          title: params.get("title") || "Anime",
        };
      }

      // Aguarda API carregar
      async function waitForAPI() {
        return new Promise((resolve, reject) => {
          if (window.AnimeAPI) {
            resolve();
            return;
          }

          let attempts = 0;
          const checkInterval = setInterval(() => {
            attempts++;
            console.log(`‚è≥ Aguardando API... (tentativa ${attempts})`);
            if (window.AnimeAPI) {
              clearInterval(checkInterval);
              resolve();
            } else if (attempts >= 50) {
              clearInterval(checkInterval);
              reject(new Error("API n√£o carregou"));
            }
          }, 100);
        });
      }

      // Carrega detalhes do anime
      async function loadAnimeDetails() {
        try {
          console.log(`üì∫ Carregando detalhes: ${currentAnimeId}`);

          const response = await window.AnimeAPI.getAnimeInfo(currentAnimeId);

          if (!response.success) {
            throw new Error("Erro ao carregar anime");
          }

          animeData = response.data;
          console.log("‚úÖ Anime carregado:", animeData);

          displayAnimeHeader(animeData);
          await loadEpisodes();
        } catch (error) {
          console.error("‚ùå Erro:", error);
          document.getElementById("anime-content").innerHTML = `
                    <div class="loading-state">
                        <p>‚ùå Erro ao carregar anime</p>
                        <button class="back-btn" onclick="window.history.back()">Voltar</button>
                    </div>
                `;
        }
      }

      // Exibe cabe√ßalho do anime
      function displayAnimeHeader(anime) {
        const poster = anime.poster || anime.image || "/placeholder.jpg";
        const title = anime.name || anime.title || "Anime";
        const description = anime.description || "Sem descri√ß√£o dispon√≠vel.";
        const rating = anime.rating || "N/A";
        const status = anime.status || "N/A";
        const type = anime.type || "TV";
        const totalEpisodes = anime.totalEpisodes || "?";
        const genres = anime.genres || [];

        const headerHTML = `
                <div class="anime-header">
                    <div class="anime-poster">
                        <img src="${poster}" alt="${title}" loading="lazy">
                    </div>
                    <div class="anime-details">
                        <h1 class="anime-title">${title}</h1>
                        <div class="anime-meta">
                            <span class="meta-item">‚≠ê ${rating}</span>
                            <span class="meta-item">üì∫ ${type}</span>
                            <span class="meta-item">üìä ${status}</span>
                            <span class="meta-item">üé¨ ${totalEpisodes} epis√≥dios</span>
                        </div>
                        <p class="anime-description">${description}</p>
                        ${
                          genres.length > 0
                            ? `
                            <div class="anime-genres">
                                ${genres
                                  .map(
                                    (g) => `<span class="genre-tag">${g}</span>`
                                  )
                                  .join("")}
                            </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;

        document.getElementById("anime-content").innerHTML = headerHTML;
      }

      // Carrega lista de epis√≥dios
      async function loadEpisodes() {
        try {
          console.log(`üì∫ Carregando epis√≥dios: ${currentAnimeId}`);

          const response = await window.AnimeAPI.getEpisodes(currentAnimeId);

          if (
            !response.success ||
            !response.data ||
            response.data.length === 0
          ) {
            throw new Error("Nenhum epis√≥dio encontrado");
          }

          const episodes = response.data;
          console.log(`‚úÖ ${episodes.length} epis√≥dios carregados`);

          displayEpisodes(episodes);
        } catch (error) {
          console.error("‚ùå Erro ao carregar epis√≥dios:", error);
          document.getElementById("anime-content").innerHTML += `
                    <div class="episodes-section">
                        <h2>üì∫ Epis√≥dios</h2>
                        <p style="color: #ff6b6b;">‚ùå Erro ao carregar epis√≥dios</p>
                    </div>
                `;
        }
      }

      // Exibe lista de epis√≥dios
      function displayEpisodes(episodes) {
        const episodesHTML = episodes
          .map(
            (ep) => `
                <div class="episode-card" onclick="playEpisode('${
                  ep.episodeId
                }', ${ep.number})">
                    <div class="episode-number">EP ${ep.number}</div>
                    <div class="episode-title">${
                      ep.title || `Epis√≥dio ${ep.number}`
                    }</div>
                </div>
            `
          )
          .join("");

        const sectionHTML = `
                <div class="episodes-section">
                    <h2>üì∫ Epis√≥dios (${episodes.length})</h2>
                    <div class="episodes-grid">
                        ${episodesHTML}
                    </div>
                </div>
            `;

        document.getElementById("anime-content").innerHTML += sectionHTML;
      }

      // Abre o player
      function playEpisode(episodeId, episodeNumber) {
        const animeTitle = animeData?.name || animeData?.title || "Anime";
        const url = `player.html?episodeId=${episodeId}&animeTitle=${encodeURIComponent(
          animeTitle
        )}&episodeNumber=${episodeNumber}`;
        console.log(`üé¨ Abrindo player: ${url}`);
        window.location.href = url;
      }

      // Inicializa√ß√£o
      async function init() {
        const params = getUrlParams();

        console.log("üöÄ Par√¢metros:", params);

        if (!params.id) {
          document.getElementById("anime-content").innerHTML = `
                    <div class="loading-state">
                        <p>‚ùå ID do anime n√£o especificado</p>
                        <button class="back-btn" onclick="window.history.back()">Voltar</button>
                    </div>
                `;
          return;
        }

        currentAnimeId = params.id;

        try {
          await waitForAPI();
          await loadAnimeDetails();
        } catch (error) {
          console.error("‚ùå Erro na inicializa√ß√£o:", error);
          document.getElementById("anime-content").innerHTML = `
                    <div class="loading-state">
                        <p>‚ùå Erro ao carregar. Recarregue a p√°gina.</p>
                        <button class="back-btn" onclick="window.history.back()">Voltar</button>
                    </div>
                `;
        }
      }

      // Inicia quando DOM carregar
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>
