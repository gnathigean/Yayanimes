<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player - YayaAnimes</title>

    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #0f0f0f;
        color: white;
        font-family: "Segoe UI", Arial, sans-serif;
      }

      .header {
        background: rgba(26, 26, 46, 0.95);
        padding: 15px 30px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 24px;
        font-weight: 700;
        color: #e50914;
      }

      .back-btn {
        padding: 10px 20px;
        background: #e50914;
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .back-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(229, 9, 20, 0.5);
      }

      .player-container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
      }

      .anime-title {
        font-size: 28px;
        margin-bottom: 10px;
        color: #e50914;
      }

      .episode-info {
        font-size: 18px;
        color: #999;
        margin-bottom: 20px;
      }

      #video {
        width: 100%;
        max-height: 720px;
        background: #000;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
      }

      #status {
        padding: 15px 20px;
        background: rgba(26, 26, 46, 0.9);
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #e50914;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #status.success {
        border-left-color: #00ff00;
      }

      #status.error {
        border-left-color: #ff0000;
        background: rgba(58, 0, 0, 0.9);
      }

      .spinner {
        border: 3px solid rgba(229, 9, 20, 0.1);
        border-left-color: #e50914;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .servers-section {
        margin-top: 30px;
        background: rgba(26, 26, 46, 0.9);
        padding: 25px;
        border-radius: 12px;
      }

      .servers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .server-btn {
        padding: 12px;
        background: rgba(42, 42, 42, 0.9);
        border: 2px solid transparent;
        color: white;
        cursor: pointer;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .server-btn:hover {
        border-color: #e50914;
        background: rgba(229, 9, 20, 0.2);
      }

      .server-btn.active {
        background: #e50914;
      }

      .retry-btn {
        padding: 12px 24px;
        background: #e50914;
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="logo">YayaAnimes</div>
      <button onclick="window.history.back()" class="back-btn">‚Üê Voltar</button>
    </div>

    <div class="player-container">
      <h1 class="anime-title" id="animeTitle">Carregando...</h1>
      <p class="episode-info" id="episodeInfo">Epis√≥dio...</p>

      <div id="status">
        <div class="spinner"></div>
        <span>Carregando player...</span>
      </div>

      <video id="video" controls></video>

      <div id="serversSection" class="servers-section" style="display: none">
        <h3>üåê Selecione o Servidor:</h3>
        <div id="serversGrid" class="servers-grid"></div>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="api-service.js"></script>

    <script>
      let hls = null;
      let currentEpisodeId = null;
      let availableServers = null;
      let availableSources = [];
      let currentSourceIndex = 0;

      // ==========================================
      // ATUALIZAR STATUS
      // ==========================================
      function updateStatus(message, type = "info", showSpinner = true) {
        const statusDiv = document.getElementById("status");
        statusDiv.className = type;
        statusDiv.innerHTML = `
        ${showSpinner ? '<div class="spinner"></div>' : ""}
        <span>${message}</span>
      `;
      }

      // ==========================================
      // INICIALIZA√á√ÉO
      // ==========================================
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const episodeId = params.get("episodeId");
        const animeTitle = params.get("animeTitle") || "Anime";
        const episodeNumber = params.get("episodeNumber") || "1";

        console.log("üöÄ Player Iniciado");

        if (!episodeId) {
          updateStatus("‚ùå ID do epis√≥dio n√£o fornecido", "error", false);
          return;
        }

        currentEpisodeId = episodeId;
        document.getElementById("animeTitle").textContent = animeTitle;
        document.getElementById(
          "episodeInfo"
        ).textContent = `Epis√≥dio ${episodeNumber}`;

        await loadServers();
      });

      // ==========================================
      // CARREGAR SERVIDORES
      // ==========================================
      async function loadServers() {
        updateStatus("üîç Buscando servidores...");

        try {
          const response = await window.AnimeAPI.getEpisodeServers(
            currentEpisodeId
          );

          if (!response.success || !response.data) {
            throw new Error("Servidores n√£o encontrados");
          }

          availableServers = response.data;
          console.log("‚úÖ Servidores:", availableServers);

          displayServers();

          // Carregar automaticamente
          if (availableServers.sub && availableServers.sub.length > 0) {
            await loadVideo("hd-1", "sub");
          } else if (availableServers.dub && availableServers.dub.length > 0) {
            await loadVideo("hd-1", "dub");
          }
        } catch (error) {
          console.error("‚ùå Erro:", error);
          updateStatus(
            "‚ùå Erro ao carregar servidores. Tentando com HD-1...",
            "error",
            false
          );
          await loadVideo("hd-1", "sub");
        }
      }

      // ==========================================
      // EXIBIR SERVIDORES
      // ==========================================
      function displayServers() {
        const section = document.getElementById("serversSection");
        const grid = document.getElementById("serversGrid");

        grid.innerHTML = "";
        section.style.display = "block";

        // SUB
        if (availableServers.sub) {
          availableServers.sub.forEach((server) => {
            const btn = document.createElement("button");
            btn.className = "server-btn";
            btn.textContent = `${server.name} (SUB)`;
            btn.onclick = () => {
              document
                .querySelectorAll(".server-btn")
                .forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");
              loadVideo(server.name.toLowerCase(), "sub");
            };
            grid.appendChild(btn);
          });
        }

        // DUB
        if (availableServers.dub) {
          availableServers.dub.forEach((server) => {
            const btn = document.createElement("button");
            btn.className = "server-btn";
            btn.textContent = `${server.name} (DUB)`;
            btn.onclick = () => {
              document
                .querySelectorAll(".server-btn")
                .forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");
              loadVideo(server.name.toLowerCase(), "dub");
            };
            grid.appendChild(btn);
          });
        }

        const firstBtn = grid.querySelector(".server-btn");
        if (firstBtn) firstBtn.classList.add("active");
      }

      // ==========================================
      // CARREGAR V√çDEO COM AUTO-FALLBACK
      // ==========================================
      async function loadVideo(server, type) {
        updateStatus(`üîç Buscando links de ${server.toUpperCase()}...`);

        try {
          const response = await window.AnimeAPI.getStreamingLinks(
            currentEpisodeId,
            server,
            type
          );

          if (
            !response.success ||
            !response.data ||
            !response.data.sources ||
            response.data.sources.length === 0
          ) {
            throw new Error("Links n√£o dispon√≠veis");
          }

          availableSources = response.data.sources;
          currentSourceIndex = 0;

          console.log(`‚úÖ ${availableSources.length} fontes dispon√≠veis`);

          // Tentar cada fonte
          await tryNextSource();
        } catch (error) {
          console.error("‚ùå Erro:", error);
          updateStatus(
            "‚ùå Erro ao buscar links. Tente outro servidor.",
            "error",
            false
          );
        }
      }

      // ==========================================
      // TENTAR PR√ìXIMA FONTE
      // ==========================================
      async function tryNextSource() {
        if (currentSourceIndex >= availableSources.length) {
          updateStatus(
            "‚ùå Todas as fontes falharam. Tente outro servidor.",
            "error",
            false
          );
          document.getElementById("status").innerHTML += `
          <button class="retry-btn" onclick="location.reload()">üîÑ Recarregar P√°gina</button>
        `;
          return;
        }

        const source = availableSources[currentSourceIndex];
        const videoUrl = source.url;
        const proxyName = source.proxy || "Unknown";

        console.log(
          `üé¨ Tentando: ${proxyName} (${currentSourceIndex + 1}/${
            availableSources.length
          })`
        );
        updateStatus(
          `üé¨ Carregando com ${proxyName}... (${currentSourceIndex + 1}/${
            availableSources.length
          })`
        );

        const video = document.getElementById("video");

        // Limpar player anterior
        if (hls) {
          hls.destroy();
          hls = null;
        }

        // Tentar com timeout
        const loadPromise = new Promise((resolve, reject) => {
          if (Hls.isSupported()) {
            hls = new Hls({
              debug: false,
              enableWorker: true,
              lowLatencyMode: true,
              xhrSetup: function (xhr, url) {
                xhr.timeout = 10000; // 10s timeout
              },
            });

            hls.loadSource(videoUrl);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
              resolve();
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
              if (data.fatal) {
                reject(new Error(data.details));
              }
            });
          } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
            video.src = videoUrl;
            video.addEventListener("loadedmetadata", () => resolve());
            video.addEventListener("error", () =>
              reject(new Error("Video error"))
            );
          } else {
            reject(new Error("HLS n√£o suportado"));
          }
        });

        // Timeout de 10 segundos
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error("Timeout")), 10000)
        );

        try {
          await Promise.race([loadPromise, timeoutPromise]);

          // SUCESSO!
          console.log(`‚úÖ Sucesso com ${proxyName}!`);
          updateStatus(`‚úÖ Reproduzindo com ${proxyName}`, "success", false);
          video.play().catch((e) => console.log("Autoplay bloqueado"));
        } catch (error) {
          console.warn(`‚ùå ${proxyName} falhou:`, error.message);

          // Tentar pr√≥xima fonte
          currentSourceIndex++;
          await tryNextSource();
        }
      }
    </script>
  </body>
</html>
