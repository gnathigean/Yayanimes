<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player - YayaAnimes</title>
    <link rel="stylesheet" href="streaming.css" />
    <style>
      /* Player Styles */
      body {
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: white;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .player-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .player-header {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player-title h1 {
        font-size: 24px;
        margin: 0 0 5px 0;
        color: white;
      }

      .player-meta {
        color: #9ca3af;
        font-size: 14px;
      }

      .btn-back {
        background: rgba(102, 126, 234, 0.2);
        color: white;
        border: 2px solid #667eea;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-back:hover {
        background: #667eea;
      }

      .video-wrapper {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
        position: relative;
        padding-top: 56.25%; /* 16:9 */
      }

      .video-wrapper iframe,
      .video-wrapper video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
      }

      .episode-selector {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .episode-selector h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
      }

      .episodes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
      }

      .episode-btn {
        background: rgba(102, 126, 234, 0.1);
        border: 2px solid rgba(102, 126, 234, 0.3);
        color: white;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        font-weight: 600;
      }

      .episode-btn:hover {
        background: rgba(102, 126, 234, 0.3);
        border-color: #667eea;
      }

      .episode-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      .episode-btn.watched {
        background: rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.5);
      }

      .server-selector {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .server-selector h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
      }

      .servers-grid {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .server-btn {
        background: rgba(102, 126, 234, 0.1);
        border: 2px solid rgba(102, 126, 234, 0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
      }

      .server-btn:hover {
        background: rgba(102, 126, 234, 0.3);
      }

      .server-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      .error-message {
        background: #ef4444;
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin: 20px 0;
      }

      .loading-state {
        text-align: center;
        padding: 40px;
        color: #9ca3af;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(102, 126, 234, 0.2);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @media (max-width: 768px) {
        .player-header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .episodes-grid {
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="player-container">
      <!-- Header -->
      <div class="player-header">
        <div class="player-title">
          <h1 id="anime-title">Carregando...</h1>
          <div class="player-meta">
            <span id="episode-info">Epis√≥dio 1</span>
          </div>
        </div>
        <a href="content.html" class="btn-back">‚Üê Voltar</a>
      </div>

      <!-- Video Player -->
      <div class="video-wrapper" id="video-container">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Carregando v√≠deo...</p>
        </div>
      </div>

      <!-- Server Selector -->
      <div class="server-selector" id="server-selector" style="display: none">
        <h3>üé¨ Selecionar Servidor</h3>
        <div class="servers-grid" id="servers-grid"></div>
      </div>

      <!-- Episode Selector -->
      <div class="episode-selector">
        <h3>üì∫ Epis√≥dios</h3>
        <div class="episodes-grid" id="episodes-grid">
          <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Carregando epis√≥dios...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="config.js"></script>
    <script src="api-service.js"></script>

    <script>
      // ===========================
      // VARI√ÅVEIS GLOBAIS
      // ===========================
      let currentAnimeId = null;
      let currentEpisodeNumber = 1;
      let animeInfo = null;
      let allEpisodes = [];
      let availableServers = [];
      let currentServer = "hd-1";
      let currentCategory = "sub";

      // ===========================
      // INICIALIZA√á√ÉO
      // ===========================
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("üé¨ Iniciando player...");

        // Verificar autentica√ß√£o
        const user = await checkAuth();
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        // Verificar assinatura
        const subscription = await checkSubscription(user.id);
        if (!subscription) {
          window.location.href = "index.html";
          return;
        }

        // Extrair par√¢metros da URL
        const params = new URLSearchParams(window.location.search);
        currentAnimeId = params.get("id");
        currentEpisodeNumber = parseInt(params.get("ep")) || 1;

        console.log("üìå Anime ID:", currentAnimeId);
        console.log("üìå Epis√≥dio:", currentEpisodeNumber);

        if (!currentAnimeId) {
          showError("ID do anime n√£o fornecido");
          return;
        }

        // Verificar se API est√° dispon√≠vel
        if (!window.AnimeAPI) {
          showError("API n√£o carregada. Recarregue a p√°gina.");
          return;
        }

        console.log("‚úÖ API dispon√≠vel");

        // Carregar anime
        await loadAnime();
      });

      // ===========================
      // CARREGAR ANIME
      // ===========================
      async function loadAnime() {
        try {
          console.log(
            `üì° Carregando anime: ${currentAnimeId}, epis√≥dio: ${currentEpisodeNumber}`
          );

          // 1. Buscar informa√ß√µes do anime
          console.log("üì° Buscando informa√ß√µes...");
          const infoResponse = await window.AnimeAPI.getAnimeInfo(
            currentAnimeId
          );

          if (!infoResponse || !infoResponse.data) {
            throw new Error("Dados do anime inv√°lidos");
          }

          animeInfo = infoResponse.data.anime.info;
          console.log("‚úÖ Info carregada:", animeInfo);

          // Atualizar t√≠tulo
          document.getElementById("anime-title").textContent = animeInfo.name;

          // 2. Buscar epis√≥dios
          console.log("üì° Buscando epis√≥dios...");
          const episodesResponse = await window.AnimeAPI.getAnimeEpisodes(
            currentAnimeId
          );

          if (!episodesResponse || !episodesResponse.episodes) {
            throw new Error("Lista de epis√≥dios inv√°lida");
          }

          allEpisodes = episodesResponse.episodes;
          console.log(
            `‚úÖ ${allEpisodes.length} epis√≥dios carregados`,
            allEpisodes
          );

          // Renderizar epis√≥dios
          renderEpisodes();

          // 3. Carregar epis√≥dio atual
          await loadEpisode(currentEpisodeNumber);
        } catch (error) {
          console.error("‚ùå Erro ao carregar anime:", error);
          showError(`Erro ao carregar: ${error.message}`);
        }
      }

      // ===========================
      // CARREGAR EPIS√ìDIO
      // ===========================
      async function loadEpisode(episodeNumber) {
        try {
          console.log(`üì° Carregando epis√≥dio ${episodeNumber}...`);

          // Encontrar epis√≥dio
          const episode = allEpisodes.find((ep) => ep.number === episodeNumber);

          if (!episode) {
            throw new Error(`Epis√≥dio ${episodeNumber} n√£o encontrado`);
          }

          console.log("‚úÖ Epis√≥dio encontrado:", episode);

          // **CORRE√á√ÉO CR√çTICA: Usar o episodeId COMPLETO**
          const fullEpisodeId = episode.episodeId;
          console.log(`üéØ Usando episodeId completo: "${fullEpisodeId}"`);

          // Atualizar UI
          document.getElementById(
            "episode-info"
          ).textContent = `Epis√≥dio ${episodeNumber} - ${
            episode.title || "Sem t√≠tulo"
          }`;
          currentEpisodeNumber = episodeNumber;

          // 1. Buscar servidores dispon√≠veis
          console.log("üì° Buscando servidores...");
          const serversResponse = await window.AnimeAPI.getEpisodeServers(
            fullEpisodeId
          );

          if (!serversResponse || !serversResponse.data) {
            throw new Error("Servidores n√£o dispon√≠veis");
          }

          // Extrair servidores SUB
          availableServers = serversResponse.data.sub || [];
          console.log("‚úÖ Servidores dispon√≠veis:", availableServers);

          if (availableServers.length === 0) {
            throw new Error("Nenhum servidor dispon√≠vel");
          }

          // Renderizar servidores
          renderServers();

          // 2. Buscar streams do primeiro servidor
          const firstServer = availableServers[0].serverName;
          currentServer = firstServer;
          console.log(`üéØ Servidor selecionado: ${currentServer}`);

          await loadStream(fullEpisodeId, currentServer);

          // Salvar no hist√≥rico
          saveToHistory(episodeNumber);
        } catch (error) {
          console.error("‚ùå Erro ao carregar epis√≥dio:", error);
          showError(`Erro ao carregar epis√≥dio: ${error.message}`);
        }
      }

      // ===========================
      // CARREGAR STREAM
      // ===========================
      async function loadStream(episodeId, server) {
        try {
          console.log(
            `üì° Carregando stream: ${episodeId} (servidor: ${server})`
          );

          const streamsResponse = await window.AnimeAPI.getEpisodeStreams(
            episodeId,
            server,
            currentCategory
          );

          if (!streamsResponse || !streamsResponse.data) {
            throw new Error("Stream n√£o dispon√≠vel");
          }

          console.log("‚úÖ Stream carregado:", streamsResponse.data);

          // Renderizar player
          renderPlayer(streamsResponse.data);
        } catch (error) {
          console.error("‚ùå Erro ao carregar stream:", error);
          showError(`Erro ao carregar v√≠deo: ${error.message}`);
        }
      }

      // ===========================
      // RENDERIZAR PLAYER
      // ===========================
      function renderPlayer(streamData) {
        const container = document.getElementById("video-container");

        // Prioridade: sources[0].url ou tracks com qualidade
        let videoUrl = null;

        if (streamData.sources && streamData.sources.length > 0) {
          videoUrl = streamData.sources[0].url;
        } else if (streamData.tracks && streamData.tracks.length > 0) {
          const bestTrack =
            streamData.tracks.find((t) => t.kind === "captions") ||
            streamData.tracks[0];
          videoUrl = bestTrack.file;
        }

        if (!videoUrl) {
          showError("URL do v√≠deo n√£o encontrada");
          return;
        }

        console.log("üé• URL do v√≠deo:", videoUrl);
        console.log(
          "üé• Tipo:",
          videoUrl.includes(".m3u8") ? "HLS Stream" : "V√≠deo direto"
        );

        // Criar elemento de v√≠deo
        container.innerHTML = `
        <video 
          id="video-player" 
          controls 
          autoplay 
          style="width: 100%; height: 100%;"
          poster="${animeInfo.poster || ""}"
        >
          Seu navegador n√£o suporta o player de v√≠deo.
        </video>
      `;

        const video = document.getElementById("video-player");

        // Verificar se √© HLS (.m3u8)
        if (videoUrl.includes(".m3u8")) {
          console.log("üé¨ Usando HLS.js para reproduzir stream");

          if (Hls.isSupported()) {
            // HLS.js √© suportado
            const hls = new Hls({
              debug: false,
              enableWorker: true,
              lowLatencyMode: true,
              backBufferLength: 90,
            });

            hls.loadSource(videoUrl);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function () {
              console.log("‚úÖ Stream HLS carregado, iniciando reprodu√ß√£o...");
              video.play().catch((err) => {
                console.warn("‚ö†Ô∏è Autoplay bloqueado:", err);
                showToast("Clique no play para iniciar", "info");
              });
            });

            hls.on(Hls.Events.ERROR, function (event, data) {
              console.error("‚ùå Erro HLS:", data);

              if (data.fatal) {
                switch (data.type) {
                  case Hls.ErrorTypes.NETWORK_ERROR:
                    console.log("üîÑ Erro de rede, tentando recuperar...");
                    hls.startLoad();
                    break;
                  case Hls.ErrorTypes.MEDIA_ERROR:
                    console.log("üîÑ Erro de m√≠dia, tentando recuperar...");
                    hls.recoverMediaError();
                    break;
                  default:
                    console.error("‚ùå Erro fatal irrecuper√°vel");
                    showError("Erro ao carregar v√≠deo. Tente outro servidor.");
                    break;
                }
              }
            });

            // Salvar inst√¢ncia para cleanup
            window.currentHls = hls;
          } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
            // Safari nativo suporta HLS
            console.log("üçé Usando suporte nativo do Safari para HLS");
            video.src = videoUrl;
            video.addEventListener("loadedmetadata", function () {
              console.log("‚úÖ Metadados carregados");
              video.play().catch((err) => {
                console.warn("‚ö†Ô∏è Autoplay bloqueado:", err);
              });
            });
          } else {
            showError(
              "Seu navegador n√£o suporta HLS. Tente usar Chrome, Firefox ou Safari."
            );
          }
        } else {
          // V√≠deo direto (MP4, etc)
          console.log("üìπ Usando reprodu√ß√£o direta de v√≠deo");
          video.src = videoUrl;
          video.play().catch((err) => {
            console.warn("‚ö†Ô∏è Autoplay bloqueado:", err);
          });
        }

        // Salvar progresso a cada 10 segundos
        video.addEventListener("timeupdate", saveProgress);
      }

      // Salvar progresso do v√≠deo
      function saveProgress() {
        const video = document.getElementById("video-player");
        if (!video) return;

        const progress = (video.currentTime / video.duration) * 100;

        // Atualizar hist√≥rico
        const history = JSON.parse(
          localStorage.getItem("watch_history") || "[]"
        );
        const index = history.findIndex(
          (h) =>
            h.animeId === currentAnimeId && h.episode === currentEpisodeNumber
        );

        if (index > -1) {
          history[index].progress = Math.round(progress);
          history[index].currentTime = video.currentTime;
          history[index].timestamp = Date.now();
          localStorage.setItem("watch_history", JSON.stringify(history));
        }
      }

      // Cleanup ao sair
      window.addEventListener("beforeunload", () => {
        if (window.currentHls) {
          window.currentHls.destroy();
        }
      });

      // ===========================
      // RENDERIZAR EPIS√ìDIOS
      // ===========================
      function renderEpisodes() {
        const grid = document.getElementById("episodes-grid");

        const watchedEpisodes = getWatchedEpisodes();

        grid.innerHTML = allEpisodes
          .map((ep) => {
            const isActive = ep.number === currentEpisodeNumber;
            const isWatched = watchedEpisodes.includes(ep.number);

            return `
          <button 
            class="episode-btn ${isActive ? "active" : ""} ${
              isWatched ? "watched" : ""
            }"
            onclick="changeEpisode(${ep.number})"
            title="${ep.title || `Epis√≥dio ${ep.number}`}"
          >
            ${ep.number}
          </button>
        `;
          })
          .join("");
      }

      // ===========================
      // RENDERIZAR SERVIDORES
      // ===========================
      function renderServers() {
        const container = document.getElementById("server-selector");
        const grid = document.getElementById("servers-grid");

        if (availableServers.length > 1) {
          container.style.display = "block";

          grid.innerHTML = availableServers
            .map((server) => {
              const isActive = server.serverName === currentServer;

              return `
            <button 
              class="server-btn ${isActive ? "active" : ""}"
              onclick="changeServer('${server.serverName}')"
            >
              ${server.serverName}
            </button>
          `;
            })
            .join("");
        }
      }

      // ===========================
      // A√á√ïES
      // ===========================
      window.changeEpisode = async function (episodeNumber) {
        if (episodeNumber === currentEpisodeNumber) return;

        // Atualizar URL
        const url = new URL(window.location);
        url.searchParams.set("ep", episodeNumber);
        window.history.pushState({}, "", url);

        // Carregar novo epis√≥dio
        await loadEpisode(episodeNumber);
        renderEpisodes();
      };

      window.changeServer = async function (serverName) {
        if (serverName === currentServer) return;

        currentServer = serverName;

        const episode = allEpisodes.find(
          (ep) => ep.number === currentEpisodeNumber
        );
        if (episode) {
          await loadStream(episode.episodeId, serverName);
        }

        renderServers();
      };

      // ===========================
      // HIST√ìRICO
      // ===========================
      function saveToHistory(episodeNumber) {
        const history = JSON.parse(
          localStorage.getItem("watch_history") || "[]"
        );

        const existingIndex = history.findIndex(
          (h) => h.animeId === currentAnimeId
        );

        const entry = {
          animeId: currentAnimeId,
          title: animeInfo.name,
          poster: animeInfo.poster,
          episode: episodeNumber,
          timestamp: Date.now(),
          progress: 0,
        };

        if (existingIndex > -1) {
          history[existingIndex] = entry;
        } else {
          history.unshift(entry);
        }

        // Manter apenas √∫ltimos 20
        localStorage.setItem(
          "watch_history",
          JSON.stringify(history.slice(0, 20))
        );
      }

      function getWatchedEpisodes() {
        const history = JSON.parse(
          localStorage.getItem("watch_history") || "[]"
        );
        const animeHistory = history.filter(
          (h) => h.animeId === currentAnimeId
        );
        return animeHistory.map((h) => h.episode);
      }

      // ===========================
      // ERRO
      // ===========================
      function showError(message) {
        const container = document.getElementById("video-container");
        container.innerHTML = `
        <div class="error-message">
          <h3>‚ùå Erro</h3>
          <p>${message}</p>
          <button onclick="location.reload()" class="btn-back" style="margin-top: 15px;">
            üîÑ Tentar Novamente
          </button>
        </div>
      `;
      }

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${
          type === "success"
            ? "#10b981"
            : type === "error"
            ? "#ef4444"
            : "#667eea"
        };
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
      `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease-out";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      console.log("‚úÖ Player.js carregado!");
    </script>
  </body>
</html>
