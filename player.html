<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player - YayAnimes Premium</title>
    <link rel="stylesheet" href="streaming.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: white;
        font-family: "Segoe UI", sans-serif;
      }

      .player-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px 20px;
        background: #1e293b;
        border-radius: 12px;
      }

      .player-header h2 {
        margin: 0;
        font-size: 20px;
      }

      .btn-back {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-back:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .video-container {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      #video-player {
        width: 100%;
        height: 70vh;
        min-height: 400px;
      }

      .player-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .episodes-panel,
      .info-panel {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
      }

      .episodes-panel h3,
      .info-panel h3 {
        margin-top: 0;
        color: #667eea;
      }

      .episodes-list {
        max-height: 400px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
      }

      .episode-btn {
        background: #0f172a;
        color: white;
        border: 2px solid #334155;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .episode-btn:hover {
        border-color: #667eea;
        background: #667eea;
      }

      .episode-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      .loading-message {
        text-align: center;
        padding: 40px;
        color: #9ca3af;
      }

      .error-message {
        background: #7f1d1d;
        color: #fecaca;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      @media (max-width: 768px) {
        .player-controls {
          grid-template-columns: 1fr;
        }

        #video-player {
          height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="player-container">
      <div class="player-header">
        <h2 id="anime-title">Carregando...</h2>
        <button class="btn-back" onclick="window.location.href='content.html'">
          ‚Üê Voltar
        </button>
      </div>

      <div class="video-container">
        <iframe
          id="video-player"
          src=""
          frameborder="0"
          allowfullscreen
        ></iframe>
      </div>

      <div class="player-controls">
        <div class="episodes-panel">
          <h3>üì∫ Epis√≥dios</h3>
          <div id="episodes-list" class="episodes-list">
            <div class="loading-message">Carregando epis√≥dios...</div>
          </div>
        </div>

        <div class="info-panel">
          <h3>‚ÑπÔ∏è Informa√ß√µes</h3>
          <div id="anime-info">
            <div class="loading-message">Carregando informa√ß√µes...</div>
          </div>
        </div>
      </div>
    </div>

    <script src="api-service.js"></script>
    <script>
      // ===========================
      // VARI√ÅVEIS GLOBAIS
      // ===========================

      let currentAnimeId = null;
      let currentEpisodeNumber = 1;
      let currentEpisodes = [];
      let animeInfo = null;

      // ===========================
      // OBTER PAR√ÇMETROS DA URL
      // ===========================

      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id"),
          ep: parseInt(params.get("ep")) || 1,
        };
      }

      // ===========================
      // AGUARDAR API
      // ===========================

      function waitForAPI() {
        return new Promise((resolve, reject) => {
          if (window.AnimeAPI) {
            console.log("‚úÖ API dispon√≠vel");
            resolve();
            return;
          }

          console.log("‚è≥ Aguardando API...");
          let attempts = 0;
          const maxAttempts = 100;

          const checkInterval = setInterval(() => {
            attempts++;

            if (window.AnimeAPI) {
              clearInterval(checkInterval);
              console.log(`‚úÖ API carregada ap√≥s ${attempts * 100}ms`);
              resolve();
            } else if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              reject(new Error("API n√£o carregou a tempo"));
            }
          }, 100);
        });
      }

      // ===========================
      // CARREGAR ANIME - CORRIGIDO
      // ===========================

      async function loadAnime(animeId, episodeNumber) {
        console.log(
          `üì° Carregando anime: ${animeId}, epis√≥dio: ${episodeNumber}`
        );

        try {
          // Carregar informa√ß√µes do anime
          console.log("üì° Buscando informa√ß√µes...");
          const infoData = await window.AnimeAPI.getAnimeInfo(animeId);
          animeInfo =
            infoData.data?.anime?.info || infoData.anime?.info || infoData;

          console.log("‚úÖ Info carregada:", animeInfo);

          // Atualizar t√≠tulo
          const title = animeInfo.name || animeInfo.title || "Anime";
          document.getElementById(
            "anime-title"
          ).textContent = `${title} - EP ${episodeNumber}`;

          // Exibir informa√ß√µes
          displayAnimeInfo(animeInfo);

          // Carregar epis√≥dios
          console.log("üì° Buscando epis√≥dios...");
          const episodesData = await window.AnimeAPI.getAnimeEpisodes(animeId);

          console.log("üì¶ Dados de epis√≥dios recebidos:", episodesData);

          // CORRE√á√ÉO CR√çTICA: Extrair epis√≥dios corretamente
          currentEpisodes =
            episodesData.episodes || episodesData.data?.episodes || [];

          console.log(
            `‚úÖ ${currentEpisodes.length} epis√≥dios carregados`,
            currentEpisodes
          );

          if (currentEpisodes.length === 0) {
            throw new Error("Nenhum epis√≥dio dispon√≠vel para este anime");
          }

          // Renderizar lista de epis√≥dios
          renderEpisodes(currentEpisodes, episodeNumber);

          // Carregar epis√≥dio atual
          const currentEpisode = currentEpisodes.find(
            (ep) => ep.number === episodeNumber
          );

          if (currentEpisode) {
            // CORRE√á√ÉO CR√çTICA: Limpar episodeId
            let cleanEpisodeId = currentEpisode.episodeId;

            // Remover query string se existir
            if (cleanEpisodeId.includes("?")) {
              cleanEpisodeId = cleanEpisodeId.split("?")[0];
            }

            console.log("üéØ EpisodeId original:", currentEpisode.episodeId);
            console.log("üéØ EpisodeId limpo:", cleanEpisodeId);

            await loadEpisode(
              cleanEpisodeId,
              episodeNumber,
              currentEpisode.title
            );
          } else {
            throw new Error(`Epis√≥dio ${episodeNumber} n√£o encontrado`);
          }
        } catch (error) {
          console.error("‚ùå Erro ao carregar anime:", error);
          showError(`Erro ao carregar: ${error.message}`);
        }
      }
      async function loadEpisode(episodeId, episodeNumber, episodeTitle) {
        console.log(`üì° Carregando epis√≥dio: ${episodeId}`);

        try {
          // VALIDA√á√ÉO CR√çTICA: episodeId deve ser APENAS n√∫meros
          const cleanEpisodeId = episodeId.split("?")[0].trim();

          // Remover qualquer caractere n√£o-num√©rico
          const numericEpisodeId = cleanEpisodeId.replace(/[^\d]/g, "");

          console.log(`üßπ EpisodeId limpo: ${numericEpisodeId}`);

          // VALIDAR que √© um n√∫mero v√°lido
          if (!numericEpisodeId || isNaN(numericEpisodeId)) {
            throw new Error(`EpisodeId inv√°lido: ${episodeId}`);
          }

          // Buscar servidores com ID CORRETO
          console.log(
            `üì° Buscando servidores para episodeId: ${numericEpisodeId}`
          );
          const serversData = await window.AnimeAPI.getEpisodeServers(
            numericEpisodeId
          );

          const servers =
            serversData.sub ||
            serversData.data?.sub ||
            serversData.servers ||
            [];

          console.log("‚úÖ Servidores dispon√≠veis:", servers);

          if (servers.length === 0) {
            throw new Error("Nenhum servidor dispon√≠vel");
          }

          // Pegar o primeiro servidor dispon√≠vel
          const server = servers[0];

          // Buscar links de streaming
          const streamsData = await window.AnimeAPI.getEpisodeStreams(
            numericEpisodeId,
            server.serverName || "hd-1",
            "sub"
          );

          console.log("‚úÖ Streams recebidos:", streamsData);

          // Extrair URL do v√≠deo
          const videoUrl =
            streamsData.sources?.[0]?.url ||
            streamsData.data?.sources?.[0]?.url ||
            streamsData.link ||
            streamsData.url;

          if (!videoUrl) {
            console.warn("‚ö†Ô∏è URL do v√≠deo n√£o encontrada");
            const videoPlayer = document.getElementById("video-player");
            videoPlayer.srcdoc = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1e293b; color: white; text-align: center; padding: 40px; font-family: sans-serif;">
          <div>
            <h2 style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</h2>
            <h3>V√≠deo Indispon√≠vel</h3>
            <p style="color: #9ca3af; margin: 20px 0;">Este epis√≥dio n√£o est√° dispon√≠vel no momento.</p>
            <p style="color: #9ca3af;">Tente outro epis√≥dio ou volte mais tarde.</p>
          </div>
        </div>
      `;
          } else {
            console.log("‚úÖ URL do v√≠deo:", videoUrl);
            const videoPlayer = document.getElementById("video-player");
            videoPlayer.src = videoUrl;
          }

          // Atualizar t√≠tulo
          const title = animeInfo?.name || animeInfo?.title || "Anime";
          document.getElementById(
            "anime-title"
          ).textContent = `${title} - EP ${episodeNumber}${
            episodeTitle ? `: ${episodeTitle}` : ""
          }`;

          // Atualizar bot√£o ativo
          document.querySelectorAll(".episode-btn").forEach((btn) => {
            btn.classList.remove("active");
            if (parseInt(btn.dataset.episode) === episodeNumber) {
              btn.classList.add("active");
            }
          });

          // Atualizar URL sem recarregar
          const newUrl = `player.html?id=${encodeURIComponent(
            currentAnimeId
          )}&ep=${episodeNumber}`;
          window.history.pushState({}, "", newUrl);

          // Salvar no hist√≥rico
          saveToHistory(currentAnimeId, title, episodeNumber);
        } catch (error) {
          console.error("‚ùå Erro ao carregar epis√≥dio:", error);

          let errorMessage = "Erro desconhecido";
          let errorIcon = "‚ùå";

          if (error.message.includes("429")) {
            errorMessage =
              "Muitas requisi√ß√µes. Aguarde alguns minutos e tente novamente.";
            errorIcon = "‚è≥";
          } else if (error.message.includes("403")) {
            errorMessage =
              "Acesso negado pela API. Este conte√∫do pode estar protegido.";
            errorIcon = "üîí";
          } else if (error.message.includes("404")) {
            errorMessage = "Epis√≥dio n√£o encontrado. Tente outro epis√≥dio.";
            errorIcon = "üîç";
          } else if (error.message.includes("inv√°lido")) {
            errorMessage = "ID do epis√≥dio inv√°lido. Recarregue a p√°gina.";
            errorIcon = "‚ö†Ô∏è";
          } else if (error.message.includes("RATE_LIMIT")) {
            errorMessage =
              "Limite de requisi√ß√µes atingido. Aguarde 60 segundos.";
            errorIcon = "‚è∏Ô∏è";
          }

          const videoPlayer = document.getElementById("video-player");
          videoPlayer.srcdoc = `
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1e293b; color: white; text-align: center; padding: 40px; font-family: sans-serif;">
        <div>
          <h2 style="font-size: 48px; margin-bottom: 20px;">${errorIcon}</h2>
          <h3>Oops! Algo deu errado</h3>
          <p style="color: #9ca3af; margin: 20px 0; max-width: 400px;">${errorMessage}</p>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button onclick="window.location.reload()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
              üîÑ Tentar Novamente
            </button>
            <button onclick="window.location.href='content.html'" style="padding: 12px 24px; background: rgba(255,255,255,0.1); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
              ‚Üê Voltar
            </button>
          </div>
        </div>
      </div>
    `;
        }
      }

      // ===========================
      // VERIFICAR DADOS DE EPIS√ìDIOS
      // ===========================

      // Adicione esta fun√ß√£o para DEBUG:
      function debugEpisodes() {
        console.log("=== DEBUG DE EPIS√ìDIOS ===");
        currentEpisodes.forEach((ep, index) => {
          console.log(`Epis√≥dio ${index}:`, {
            number: ep.number,
            episodeId: ep.episodeId,
            title: ep.title,
            tipo: typeof ep.episodeId,
          });
        });
      }

      // ===========================
      // RENDERIZAR EPIS√ìDIOS
      // ===========================

      function renderEpisodes(episodes, currentEp) {
        const container = document.getElementById("episodes-list");

        if (episodes.length === 0) {
          container.innerHTML =
            '<p style="color: #9ca3af;">Nenhum epis√≥dio dispon√≠vel</p>';
          return;
        }

        container.innerHTML = episodes
          .map(
            (ep) => `
        <button 
          class="episode-btn ${ep.number === currentEp ? "active" : ""}" 
          data-episode="${ep.number}"
          onclick="selectEpisode('${ep.episodeId}', ${ep.number}, '${escapeHtml(
              ep.title || ""
            )}')"
        >
          EP ${ep.number}
        </button>
      `
          )
          .join("");
      }

      // ===========================
      // SELECIONAR EPIS√ìDIO - CORRIGIDO
      // ===========================

      function selectEpisode(episodeId, episodeNumber, episodeTitle) {
        console.log("üéØ EpisodeId original:", episodeId);

        // CORRIGIDO: EXTRAIR o ID do epis√≥dio (n√£o remover a query string)
        let finalEpisodeId = episodeId;

        // Se tem formato "animeId?ep=145012", extrair APENAS "145012"
        if (episodeId.includes("?ep=")) {
          finalEpisodeId = episodeId.split("?ep=")[1];
          console.log(
            "‚úÖ Formato com ?ep= detectado, extraindo episodeId:",
            finalEpisodeId
          );
        }
        // Se tem apenas "?", pode ser outro formato
        else if (episodeId.includes("?")) {
          const parts = episodeId.split("?");
          // Tentar extrair o n√∫mero ap√≥s o ?
          const afterQuestion = parts[1];
          if (/^\d+$/.test(afterQuestion)) {
            finalEpisodeId = afterQuestion;
            console.log("‚úÖ Formato com ? simples, extraindo:", finalEpisodeId);
          }
        }

        console.log("üéØ EpisodeId limpo (FINAL):", finalEpisodeId);

        currentEpisodeNumber = episodeNumber;
        loadEpisode(finalEpisodeId, episodeNumber, episodeTitle);
      }

      // ===========================
      // EXIBIR INFORMA√á√ïES
      // ===========================

      function displayAnimeInfo(info) {
        const container = document.getElementById("anime-info");

        container.innerHTML = `
        <div style="line-height: 1.8;">
          <p><strong>Nome:</strong> ${escapeHtml(
            info.name || info.title || "N/A"
          )}</p>
          ${
            info.jname
              ? `<p><strong>Nome JP:</strong> ${escapeHtml(info.jname)}</p>`
              : ""
          }
          <p><strong>‚≠ê Rating:</strong> ${info.rating || "N/A"}</p>
          ${
            info.stats?.episodes?.sub
              ? `<p><strong>üì∫ Epis√≥dios:</strong> ${info.stats.episodes.sub}</p>`
              : ""
          }
          ${
            info.stats?.type
              ? `<p><strong>üìÖ Tipo:</strong> ${info.stats.type}</p>`
              : ""
          }
          ${
            info.stats?.status
              ? `<p><strong>Status:</strong> ${info.stats.status}</p>`
              : ""
          }
          ${
            info.description
              ? `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #334155;">
              <p style="color: #9ca3af; line-height: 1.6;">${escapeHtml(
                info.description
              ).substring(0, 300)}...</p>
            </div>
          `
              : ""
          }
        </div>
      `;
      }

      // ===========================
      // SALVAR NO HIST√ìRICO
      // ===========================

      function saveToHistory(animeId, animeTitle, episodeNumber) {
        const history = JSON.parse(
          localStorage.getItem("watch_history") || "[]"
        );

        const existingIndex = history.findIndex((item) => item.id === animeId);

        const historyItem = {
          id: animeId,
          title: animeTitle,
          image: animeInfo?.poster || "",
          episode: episodeNumber,
          progress: Math.min(
            100,
            Math.round((episodeNumber / (currentEpisodes.length || 1)) * 100)
          ),
          lastWatched: new Date().toISOString(),
          type: "anime",
        };

        if (existingIndex >= 0) {
          history[existingIndex] = historyItem;
        } else {
          history.unshift(historyItem);
        }

        // Manter apenas os 20 mais recentes
        if (history.length > 20) {
          history.splice(20);
        }

        localStorage.setItem("watch_history", JSON.stringify(history));
        console.log("‚úÖ Hist√≥rico atualizado:", historyItem);
      }

      // ===========================
      // UTILIT√ÅRIOS
      // ===========================

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showError(message) {
        const container = document.querySelector(".player-container");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.innerHTML = `
        <h3>‚ùå Erro</h3>
        <p>${message}</p>
        <button onclick="window.location.reload()" class="btn-back" style="margin-top: 10px;">
          üîÑ Tentar Novamente
        </button>
      `;
        container.insertBefore(errorDiv, container.firstChild);
      }

      // ===========================
      // INICIALIZA√á√ÉO
      // ===========================

      (async function init() {
        console.log("üé¨ Iniciando player...");

        try {
          // Obter par√¢metros da URL
          const params = getUrlParams();

          if (!params.id) {
            throw new Error("ID do anime n√£o fornecido na URL");
          }

          currentAnimeId = params.id;
          currentEpisodeNumber = params.ep;

          console.log(`üìå Anime ID: ${currentAnimeId}`);
          console.log(`üìå Epis√≥dio: ${currentEpisodeNumber}`);

          // Aguardar API carregar
          await waitForAPI();

          // Carregar anime
          await loadAnime(currentAnimeId, currentEpisodeNumber);
        } catch (error) {
          console.error("‚ùå Erro na inicializa√ß√£o:", error);
          showError(`Falha ao inicializar: ${error.message}`);
        }
      })();

      // ===========================
      // NAVEGA√á√ÉO DO HIST√ìRICO
      // ===========================

      window.addEventListener("popstate", function () {
        const params = getUrlParams();
        if (params.id && params.ep) {
          const episode = currentEpisodes.find((ep) => ep.number === params.ep);
          if (episode) {
            loadEpisode(episode.episodeId, params.ep, episode.title);
          }
        }
      });

      // Expor fun√ß√µes globalmente
      window.selectEpisode = selectEpisode;
    </script>
  </body>
</html>
