<!-- Adicionar após o script do player, antes de </body> -->
<script>
  // CORREÇÃO: Garantir que a API está carregada
  function waitForAPI() {
    return new Promise((resolve) => {
      if (window.AnimeAPI) {
        resolve();
      } else {
        const checkInterval = setInterval(() => {
          if (window.AnimeAPI) {
            clearInterval(checkInterval);
            resolve();
          }
        }, 100);

        // Timeout após 10 segundos
        setTimeout(() => {
          clearInterval(checkInterval);
          if (!window.AnimeAPI) {
            showMessage(
              "❌ Erro ao carregar API. Recarregue a página.",
              "error"
            );
          }
        }, 10000);
      }
    });
  }

  // Inicialização melhorada
  (async function () {
    if (animeId) {
      await waitForAPI();
      loadAnime(animeId, episodeNumber);
    } else {
      showMessage("❌ ID do anime não fornecido", "error");
    }
  })();

  // Adicionar volta ao histórico
  window.addEventListener("popstate", function () {
    const newEp = new URLSearchParams(window.location.search).get("ep") || "1";
    const episodeData = currentEpisodes.find(
      (ep) => ep.number === parseInt(newEp)
    );
    if (episodeData) {
      loadEpisode(episodeData.episodeId, episodeData.number, episodeData.title);
    }
  });

  // Prevenir fechamento acidental durante reprodução
  window.addEventListener("beforeunload", function (e) {
    const video = document.getElementById("video-player");
    if (video && !video.paused && video.currentTime > 0) {
      e.preventDefault();
      e.returnValue = "Você está assistindo um vídeo. Deseja realmente sair?";
    }
  });

  // Salvar progresso automaticamente
  let progressInterval;
  const video = document.getElementById("video-player");

  if (video) {
    video.addEventListener("play", function () {
      progressInterval = setInterval(() => {
        if (video.duration > 0) {
          const progress = Math.round(
            (video.currentTime / video.duration) * 100
          );
          localStorage.setItem(
            `progress_${animeId}_${episodeNumber}`,
            progress
          );
        }
      }, 5000);
    });

    video.addEventListener("pause", function () {
      clearInterval(progressInterval);
    });

    video.addEventListener("ended", function () {
      clearInterval(progressInterval);
      // Auto-avançar para próximo episódio
      const nextEp = currentEpisodes.find(
        (ep) => ep.number === episodeNumber + 1
      );
      if (nextEp && confirm("Episódio finalizado! Assistir o próximo?")) {
        selectEpisode(nextEp.episodeId, nextEp.number, nextEp.title);
      }
    });
  }
</script>
