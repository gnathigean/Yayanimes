<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player - YayAnimes Premium</title>
    <link rel="stylesheet" href="streaming.css" />
    <!-- HLS.js para reprodu√ß√£o de v√≠deos HLS -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: white;
        font-family: "Segoe UI", sans-serif;
      }

      .player-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px 20px;
        background: #1e293b;
        border-radius: 12px;
      }

      .player-header h2 {
        margin: 0;
        font-size: 20px;
      }

      .btn-back {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-back:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .video-container {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      #video-player {
        width: 100%;
        height: 70vh;
        min-height: 400px;
      }

      .player-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .episodes-panel,
      .info-panel {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
      }

      .episodes-panel h3,
      .info-panel h3 {
        margin-top: 0;
        color: #667eea;
      }

      .episodes-list {
        max-height: 400px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
      }

      .episode-btn {
        background: #0f172a;
        color: white;
        border: 2px solid #334155;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .episode-btn:hover {
        border-color: #667eea;
        background: #667eea;
      }

      .episode-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      .loading-message {
        text-align: center;
        padding: 40px;
        color: #9ca3af;
      }

      .error-message {
        background: #7f1d1d;
        color: #fecaca;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      @media (max-width: 768px) {
        .player-controls {
          grid-template-columns: 1fr;
        }

        #video-player {
          height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="player-container">
      <div class="player-header">
        <h2 id="anime-title">Carregando...</h2>
        <button class="btn-back" onclick="window.location.href='content.html'">
          ‚Üê Voltar
        </button>
      </div>

      <div class="video-container">
        <video
          id="video-player"
          controls
          playsinline
          style="width: 100%; height: 100%; background: #000"
        ></video>
      </div>

      <div class="player-controls">
        <div class="episodes-panel">
          <h3>üì∫ Epis√≥dios</h3>
          <div id="episodes-list" class="episodes-list">
            <div class="loading-message">Carregando epis√≥dios...</div>
          </div>
        </div>

        <div class="info-panel">
          <h3>‚ÑπÔ∏è Informa√ß√µes</h3>
          <div id="anime-info">
            <div class="loading-message">Carregando informa√ß√µes...</div>
          </div>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="api-service.js"></script>
    <script>
      // ===========================
      // VARI√ÅVEIS GLOBAIS
      // ===========================

      let currentAnimeId = null;
      let currentEpisodeNumber = 1;
      let currentEpisodes = [];
      let animeInfo = null;
      let hlsInstance = null;

      // ===========================
      // OBTER PAR√ÇMETROS DA URL
      // ===========================

      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id"),
          ep: parseInt(params.get("ep")) || 1,
        };
      }

      // ===========================
      // AGUARDAR API
      // ===========================

      function waitForAPI() {
        return new Promise((resolve, reject) => {
          if (window.AnimeAPI) {
            console.log("‚úÖ API dispon√≠vel");
            resolve();
            return;
          }

          console.log("‚è≥ Aguardando API...");
          let attempts = 0;
          const maxAttempts = 100;

          const checkInterval = setInterval(() => {
            attempts++;

            if (window.AnimeAPI) {
              clearInterval(checkInterval);
              console.log(`‚úÖ API carregada ap√≥s ${attempts * 100}ms`);
              resolve();
            } else if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              reject(new Error("API n√£o carregou a tempo"));
            }
          }, 100);
        });
      }

      // ===========================
      // INICIALIZAR PLAYER HLS
      // ===========================

      function initializeHlsPlayer(videoUrl) {
        const video = document.getElementById("video-player");

        // Destruir inst√¢ncia anterior se existir
        if (hlsInstance) {
          hlsInstance.destroy();
        }

        if (Hls.isSupported()) {
          hlsInstance = new Hls({
            xhrSetup: function (xhr, url) {
              xhr.withCredentials = false;
            },
            maxLoadingDelay: 4,
            minAutoBitrate: 0,
            debug: false,
          });

          hlsInstance.loadSource(videoUrl);
          hlsInstance.attachMedia(video);

          hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () {
            console.log("‚úÖ HLS Manifest carregado com sucesso");
            video.play().catch((err) => {
              console.warn("Auto play bloqueado:", err);
            });
          });

          hlsInstance.on(Hls.Events.ERROR, function (event, data) {
            console.error("‚ùå Erro HLS:", data);

            if (data.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  console.error("Erro de rede - tentando recuperar...");
                  hlsInstance.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  console.error("Erro no media player");
                  hlsInstance.recoverMediaError();
                  break;
                default:
                  console.error("Erro fatal n√£o recuper√°vel");
                  hlsInstance.destroy();
                  showError("Erro ao carregar v√≠deo. Tente outro epis√≥dio.");
                  break;
              }
            }
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          // Suporte nativo HLS (Safari)
          video.src = videoUrl;
        } else {
          showError("Seu navegador n√£o suporta HLS");
        }
      }

      // ===========================
      // CARREGAR ANIME
      // ===========================

      async function loadAnime(animeId, episodeNumber) {
        console.log(
          `üì° Carregando anime: ${animeId}, epis√≥dio: ${episodeNumber}`
        );

        try {
          console.log("üì° Buscando informa√ß√µes...");
          const infoData = await window.AnimeAPI.getAnimeInfo(animeId);
          animeInfo =
            infoData.data?.anime?.info || infoData.anime?.info || infoData;

          console.log("‚úÖ Info carregada:", animeInfo);

          const title = animeInfo.name || animeInfo.title || "Anime";
          document.getElementById(
            "anime-title"
          ).textContent = `${title} - EP ${episodeNumber}`;

          displayAnimeInfo(animeInfo);

          console.log("üì° Buscando epis√≥dios...");
          const episodesData = await window.AnimeAPI.getAnimeEpisodes(animeId);

          currentEpisodes =
            episodesData.episodes || episodesData.data?.episodes || [];

          console.log(
            `‚úÖ ${currentEpisodes.length} epis√≥dios carregados`,
            currentEpisodes
          );

          if (currentEpisodes.length === 0) {
            throw new Error("Nenhum epis√≥dio dispon√≠vel para este anime");
          }

          renderEpisodes(currentEpisodes, episodeNumber);

          const currentEpisode = currentEpisodes.find(
            (ep) => ep.number === episodeNumber
          );

          if (currentEpisode) {
            await loadEpisode(
              currentEpisode.episodeId,
              episodeNumber,
              currentEpisode.title
            );
          } else {
            throw new Error(`Epis√≥dio ${episodeNumber} n√£o encontrado`);
          }
        } catch (error) {
          console.error("‚ùå Erro ao carregar anime:", error);
          showError(`Erro ao carregar: ${error.message}`);
        }
      }

      // ===========================
      // CARREGAR EPIS√ìDIO - VERS√ÉO FINAL CORRIGIDA
      // ===========================

      async function loadEpisode(episodeId, episodeNumber, episodeTitle) {
        console.log(`üì° Carregando epis√≥dio: ${episodeId}`);

        try {
          // PASSO 1: Extrair episodeId num√©rico
          let numericEpisodeId = episodeId;
          let completeEpisodeId = episodeId;

          if (episodeId.includes("?ep=")) {
            // Formato: "animeId?ep=145526"
            const parts = episodeId.split("?ep=");
            numericEpisodeId = parts[1];
            completeEpisodeId = episodeId;
            console.log("‚úÖ Formato ?ep= detectado");
            console.log("   - Num√©rico:", numericEpisodeId);
            console.log("   - Completo:", completeEpisodeId);
          } else if (episodeId.includes("?")) {
            // Outros formatos com ?
            const parts = episodeId.split("?");
            numericEpisodeId = parts[1];
            completeEpisodeId = episodeId;
            console.log("‚úÖ Formato ? simples detectado");
          }

          // PASSO 2: Tentar obter servidores
          let serversData = null;
          let serverEpisodeId = completeEpisodeId; // ID para usar nos servidores

          try {
            console.log(`üì° Buscando servidores com: ${completeEpisodeId}`);
            serversData = await window.AnimeAPI.getEpisodeServers(
              completeEpisodeId
            );
          } catch (error1) {
            console.warn("‚ùå Tentativa com episodeId completo falhou");

            // Tentar com apenas o num√©rico
            if (completeEpisodeId !== numericEpisodeId) {
              try {
                console.log(
                  `üì° Tentando com episodeId num√©rico: ${numericEpisodeId}`
                );
                serversData = await window.AnimeAPI.getEpisodeServers(
                  numericEpisodeId
                );
                serverEpisodeId = numericEpisodeId;
              } catch (error2) {
                console.error("‚ùå Ambas tentativas falharam");
                throw error2;
              }
            } else {
              throw error1;
            }
          }

          const servers =
            serversData.sub ||
            serversData.data?.sub ||
            serversData.servers ||
            [];

          console.log("‚úÖ Servidores dispon√≠veis:", servers);

          if (servers.length === 0) {
            throw new Error("Nenhum servidor dispon√≠vel para este epis√≥dio");
          }

          const server = servers[0];
          console.log(
            `üéØ Servidor selecionado: ${server.serverName || "hd-1"}`
          );

          // PASSO 3: Buscar streams - SEMPRE usar apenas o ID num√©rico
          console.log(
            `üì° Buscando streams com episodeId num√©rico: ${numericEpisodeId}`
          );
          const streamsData = await window.AnimeAPI.getEpisodeStreams(
            numericEpisodeId, // IMPORTANTE: Sempre usar ID num√©rico aqui!
            server.serverName || "hd-1",
            "sub"
          );

          console.log("‚úÖ Streams recebidos:", streamsData);

          const videoUrl =
            streamsData.sources?.[0]?.url ||
            streamsData.data?.sources?.[0]?.url ||
            streamsData.link ||
            streamsData.url;

          if (!videoUrl) {
            console.warn("‚ö†Ô∏è URL do v√≠deo n√£o encontrada");
            showError("V√≠deo n√£o dispon√≠vel para este epis√≥dio");
            return;
          }

          console.log(
            "‚úÖ URL do v√≠deo obtida:",
            videoUrl.substring(0, 60) + "..."
          );

          // PASSO 4: Inicializar player
          if (videoUrl.includes(".m3u8")) {
            console.log("üé¨ Inicializando player HLS...");
            initializeHlsPlayer(videoUrl);
          } else {
            console.log("üé¨ Carregando v√≠deo direto...");
            const video = document.getElementById("video-player");
            video.src = videoUrl;
          }

          // PASSO 5: Atualizar UI
          const title = animeInfo?.name || animeInfo?.title || "Anime";
          document.getElementById(
            "anime-title"
          ).textContent = `${title} - EP ${episodeNumber}${
            episodeTitle ? `: ${episodeTitle}` : ""
          }`;

          document.querySelectorAll(".episode-btn").forEach((btn) => {
            btn.classList.remove("active");
            if (parseInt(btn.dataset.episode) === episodeNumber) {
              btn.classList.add("active");
            }
          });

          const newUrl = `player.html?id=${encodeURIComponent(
            currentAnimeId
          )}&ep=${episodeNumber}`;
          window.history.pushState({}, "", newUrl);

          saveToHistory(currentAnimeId, title, episodeNumber);
        } catch (error) {
          console.error("‚ùå Erro ao carregar epis√≥dio:", error);
          console.error("üìã Informa√ß√µes do erro:");
          console.error("  - Mensagem:", error.message);
          console.error("  - Stack:", error.stack);

          showError(`Erro: ${error.message}`);
        }
      }

      // ===========================
      // FUN√á√ÉO DE DEBUG
      // ===========================

      function debugEpisodes() {
        console.log("=== DEBUG DE EPIS√ìDIOS ===");
        if (!currentEpisodes || currentEpisodes.length === 0) {
          console.log("‚ùå Nenhum epis√≥dio carregado");
          return;
        }

        currentEpisodes.forEach((ep, index) => {
          console.log(`\nEpis√≥dio ${index}:`);
          console.log("  number:", ep.number);
          console.log("  episodeId:", ep.episodeId);
          console.log("  episodeId (tipo):", typeof ep.episodeId);
          console.log("  episodeId (length):", ep.episodeId.length);
          console.log("  title:", ep.title);
          console.log("  isFiller:", ep.isFiller);
        });
        console.log("\n=== FIM DEBUG ===");
      }

      window.debugEpisodes = debugEpisodes;

      // ===========================
      // RENDERIZAR EPIS√ìDIOS
      // ===========================

      function renderEpisodes(episodes, currentEp) {
        const container = document.getElementById("episodes-list");

        if (episodes.length === 0) {
          container.innerHTML =
            '<p style="color: #9ca3af;">Nenhum epis√≥dio dispon√≠vel</p>';
          return;
        }

        container.innerHTML = episodes
          .map(
            (ep) => `
        <button 
          class="episode-btn ${ep.number === currentEp ? "active" : ""}" 
          data-episode="${ep.number}"
          onclick="selectEpisode('${ep.episodeId}', ${ep.number}, '${escapeHtml(
              ep.title || ""
            )}')"
        >
          EP ${ep.number}
        </button>
      `
          )
          .join("");
      }

      // ===========================
      // SELECIONAR EPIS√ìDIO
      // ===========================

      function selectEpisode(episodeId, episodeNumber, episodeTitle) {
        console.log("üéØ EpisodeId original:", episodeId);

        let finalEpisodeId = episodeId;
        if (episodeId.includes("?ep=")) {
          finalEpisodeId = episodeId.split("?ep=")[1];
          console.log("‚úÖ Extra√≠do:", finalEpisodeId);
        }

        console.log("üéØ EpisodeId final:", finalEpisodeId);
        currentEpisodeNumber = episodeNumber;
        loadEpisode(finalEpisodeId, episodeNumber, episodeTitle);
      }

      // ===========================
      // EXIBIR INFORMA√á√ïES
      // ===========================

      function displayAnimeInfo(info) {
        const container = document.getElementById("anime-info");

        container.innerHTML = `
        <div style="line-height: 1.8;">
          <p><strong>Nome:</strong> ${escapeHtml(
            info.name || info.title || "N/A"
          )}</p>
          ${
            info.jname
              ? `<p><strong>Nome JP:</strong> ${escapeHtml(info.jname)}</p>`
              : ""
          }
          <p><strong>‚≠ê Rating:</strong> ${info.rating || "N/A"}</p>
          ${
            info.stats?.episodes?.sub
              ? `<p><strong>üì∫ Epis√≥dios:</strong> ${info.stats.episodes.sub}</p>`
              : ""
          }
          ${
            info.stats?.type
              ? `<p><strong>üìã Tipo:</strong> ${info.stats.type}</p>`
              : ""
          }
          ${
            info.stats?.status
              ? `<p><strong>Status:</strong> ${info.stats.status}</p>`
              : ""
          }
        </div>
      `;
      }

      // ===========================
      // SALVAR NO HIST√ìRICO
      // ===========================

      function saveToHistory(animeId, animeTitle, episodeNumber) {
        const history = JSON.parse(
          localStorage.getItem("watch_history") || "[]"
        );

        const existingIndex = history.findIndex((item) => item.id === animeId);

        const historyItem = {
          id: animeId,
          title: animeTitle,
          image: animeInfo?.poster || "",
          episode: episodeNumber,
          progress: Math.min(
            100,
            Math.round((episodeNumber / (currentEpisodes.length || 1)) * 100)
          ),
          lastWatched: new Date().toISOString(),
          type: "anime",
        };

        if (existingIndex >= 0) {
          history[existingIndex] = historyItem;
        } else {
          history.unshift(historyItem);
        }

        if (history.length > 20) {
          history.splice(20);
        }

        localStorage.setItem("watch_history", JSON.stringify(history));
        console.log("‚úÖ Hist√≥rico atualizado:", historyItem);
      }

      // ===========================
      // UTILIT√ÅRIOS
      // ===========================

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showError(message) {
        const container = document.querySelector(".player-container");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.innerHTML = `
        <h3>‚ùå Erro</h3>
        <p>${message}</p>
        <button onclick="window.location.reload()" class="btn-back" style="margin-top: 10px;">
          üîÑ Tentar Novamente
        </button>
      `;
        container.insertBefore(errorDiv, container.firstChild);
      }

      // ===========================
      // INICIALIZA√á√ÉO
      // ===========================

      (async function init() {
        console.log("üé¨ Iniciando player...");

        try {
          const params = getUrlParams();

          if (!params.id) {
            throw new Error("ID do anime n√£o fornecido na URL");
          }

          currentAnimeId = params.id;
          currentEpisodeNumber = params.ep;

          console.log(`üìå Anime ID: ${currentAnimeId}`);
          console.log(`üìå Epis√≥dio: ${currentEpisodeNumber}`);

          await waitForAPI();
          await loadAnime(currentAnimeId, currentEpisodeNumber);
        } catch (error) {
          console.error("‚ùå Erro na inicializa√ß√£o:", error);
          showError(`Falha ao inicializar: ${error.message}`);
        }
      })();

      // ===========================
      // NAVEGA√á√ÉO DO HIST√ìRICO
      // ===========================

      window.addEventListener("popstate", function () {
        const params = getUrlParams();
        if (params.id && params.ep) {
          const episode = currentEpisodes.find((ep) => ep.number === params.ep);
          if (episode) {
            loadEpisode(episode.episodeId, params.ep, episode.title);
          }
        }
      });

      window.selectEpisode = selectEpisode;
    </script>
  </body>
</html>
