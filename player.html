// =========================== // FUN√á√ÉO CORRIGIDA: selectEpisode //
=========================== function selectEpisode(episodeId, episodeNumber,
episodeTitle) { console.log("üéØ EpisodeId original:", episodeId); // CORRIGIDO:
EXTRAIR o ID do epis√≥dio (n√£o remover a query string) let finalEpisodeId =
episodeId; // Se tem formato "animeId?ep=145012", extrair APENAS "145012" if
(episodeId.includes("?ep=")) { finalEpisodeId = episodeId.split("?ep=")[1];
console.log("‚úÖ Formato com ?ep= detectado, extraindo episodeId:",
finalEpisodeId); } // Se tem apenas "?", pode ser outro formato else if
(episodeId.includes("?")) { const parts = episodeId.split("?"); // Tentar
extrair o n√∫mero ap√≥s o ? const afterQuestion = parts[1]; if
(/^\d+$/.test(afterQuestion)) { finalEpisodeId = afterQuestion; console.log("‚úÖ
Formato com ? simples, extraindo:", finalEpisodeId); } } console.log("üéØ
EpisodeId limpo (FINAL):", finalEpisodeId); currentEpisodeNumber =
episodeNumber; loadEpisode(finalEpisodeId, episodeNumber, episodeTitle); } //
=========================== // FUN√á√ÉO CORRIGIDA: loadEpisode //
=========================== async function loadEpisode(episodeId, episodeNumber,
episodeTitle) { console.log(`üì° Carregando epis√≥dio: ${episodeId}`); try { //
VALIDA√á√ÉO CR√çTICA: episodeId deve ser APENAS n√∫meros const cleanEpisodeId =
episodeId.split("?")[0].trim(); // Remover qualquer caractere n√£o-num√©rico const
numericEpisodeId = cleanEpisodeId.replace(/[^\d]/g, ''); console.log(`üßπ
EpisodeId limpo: ${numericEpisodeId}`); // VALIDAR que √© um n√∫mero v√°lido if
(!numericEpisodeId || isNaN(numericEpisodeId)) { throw new Error(`EpisodeId
inv√°lido: ${episodeId}`); } // Buscar servidores com ID CORRETO console.log(`üì°
Buscando servidores para episodeId: ${numericEpisodeId}`); const serversData =
await window.AnimeAPI.getEpisodeServers(numericEpisodeId); const servers =
serversData.sub || serversData.data?.sub || serversData.servers || [];
console.log("‚úÖ Servidores dispon√≠veis:", servers); if (servers.length === 0) {
throw new Error("Nenhum servidor dispon√≠vel"); } // Pegar o primeiro servidor
dispon√≠vel const server = servers[0]; // Buscar links de streaming const
streamsData = await window.AnimeAPI.getEpisodeStreams( numericEpisodeId,
server.serverName || "hd-1", "sub" ); console.log("‚úÖ Streams recebidos:",
streamsData); // Extrair URL do v√≠deo const videoUrl =
streamsData.sources?.[0]?.url || streamsData.data?.sources?.[0]?.url ||
streamsData.link || streamsData.url; if (!videoUrl) { console.warn("‚ö†Ô∏è URL do
v√≠deo n√£o encontrada"); const videoPlayer =
document.getElementById("video-player"); videoPlayer.srcdoc = `
<div
  style="
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: #1e293b;
    color: white;
    text-align: center;
    padding: 40px;
    font-family: sans-serif;
  "
>
  <div>
    <h2 style="font-size: 48px; margin-bottom: 20px">‚ö†Ô∏è</h2>
    <h3>V√≠deo Indispon√≠vel</h3>
    <p style="color: #9ca3af; margin: 20px 0">
      Este epis√≥dio n√£o est√° dispon√≠vel no momento.
    </p>
    <p style="color: #9ca3af">Tente outro epis√≥dio ou volte mais tarde.</p>
  </div>
</div>
`; } else { console.log("‚úÖ URL do v√≠deo:", videoUrl); const videoPlayer =
document.getElementById("video-player"); videoPlayer.src = videoUrl; } //
Atualizar t√≠tulo const title = animeInfo?.name || animeInfo?.title || "Anime";
document.getElementById( "anime-title" ).textContent = `${title} - EP
${episodeNumber}${ episodeTitle ? `: ${episodeTitle}` : "" }`; // Atualizar
bot√£o ativo document.querySelectorAll(".episode-btn").forEach((btn) => {
btn.classList.remove("active"); if (parseInt(btn.dataset.episode) ===
episodeNumber) { btn.classList.add("active"); } }); // Atualizar URL sem
recarregar const newUrl = `player.html?id=${encodeURIComponent( currentAnimeId
)}&ep=${episodeNumber}`; window.history.pushState({}, "", newUrl); // Salvar no
hist√≥rico saveToHistory(currentAnimeId, title, episodeNumber); } catch (error) {
console.error("‚ùå Erro ao carregar epis√≥dio:", error); let errorMessage = "Erro
desconhecido"; let errorIcon = "‚ùå"; if (error.message.includes("429")) {
errorMessage = "Muitas requisi√ß√µes. Aguarde alguns minutos e tente novamente.";
errorIcon = "‚è≥"; } else if (error.message.includes("403")) { errorMessage =
"Acesso negado pela API. Este conte√∫do pode estar protegido."; errorIcon = "üîí";
} else if (error.message.includes("404")) { errorMessage = "Epis√≥dio n√£o
encontrado. Tente outro epis√≥dio."; errorIcon = "üîç"; } else if
(error.message.includes("inv√°lido")) { errorMessage = "ID do epis√≥dio inv√°lido.
Recarregue a p√°gina."; errorIcon = "‚ö†Ô∏è"; } else if
(error.message.includes("RATE_LIMIT")) { errorMessage = "Limite de requisi√ß√µes
atingido. Aguarde 60 segundos."; errorIcon = "‚è∏Ô∏è"; } const videoPlayer =
document.getElementById("video-player"); videoPlayer.srcdoc = `
<div
  style="
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: #1e293b;
    color: white;
    text-align: center;
    padding: 40px;
    font-family: sans-serif;
  "
>
  <div>
    <h2 style="font-size: 48px; margin-bottom: 20px">${errorIcon}</h2>
    <h3>Oops! Algo deu errado</h3>
    <p style="color: #9ca3af; margin: 20px 0; max-width: 400px">
      ${errorMessage}
    </p>
    <div
      style="
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      "
    >
      <button
        onclick="window.location.reload()"
        style="
          padding: 12px 24px;
          background: #667eea;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
        "
      >
        üîÑ Tentar Novamente
      </button>
      <button
        onclick="window.location.href='content.html'"
        style="
          padding: 12px 24px;
          background: rgba(255, 255, 255, 0.1);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
        "
      >
        ‚Üê Voltar
      </button>
    </div>
  </div>
</div>
`; } } // =========================== // VERIFICAR DADOS DE EPIS√ìDIOS //
=========================== // Adicione esta fun√ß√£o para DEBUG: function
debugEpisodes() { console.log("=== DEBUG DE EPIS√ìDIOS ===");
currentEpisodes.forEach((ep, index) => { console.log(`Epis√≥dio ${index}:`, {
number: ep.number, episodeId: ep.episodeId, title: ep.title, tipo: typeof
ep.episodeId }); }); } // Chame assim no console se precisar: // debugEpisodes()
