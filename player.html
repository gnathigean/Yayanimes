<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player - YayAnimes Premium</title>
    <link rel="stylesheet" href="streaming.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: white;
        font-family: "Segoe UI", sans-serif;
      }

      .player-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px 20px;
        background: #1e293b;
        border-radius: 12px;
      }

      .player-header h2 {
        margin: 0;
        font-size: 20px;
      }

      .btn-back {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-back:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .video-container {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      #video-player {
        width: 100%;
        height: 70vh;
        min-height: 400px;
      }

      .player-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .episodes-panel,
      .info-panel {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
      }

      .episodes-panel h3,
      .info-panel h3 {
        margin-top: 0;
        color: #667eea;
      }

      .episodes-list {
        max-height: 400px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
      }

      .episode-btn {
        background: #0f172a;
        color: white;
        border: 2px solid #334155;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .episode-btn:hover {
        border-color: #667eea;
        background: #667eea;
      }

      .episode-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      .loading-message {
        text-align: center;
        padding: 40px;
        color: #9ca3af;
      }

      .error-message {
        background: #7f1d1d;
        color: #fecaca;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      @media (max-width: 768px) {
        .player-controls {
          grid-template-columns: 1fr;
        }

        #video-player {
          height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="player-container">
      <div class="player-header">
        <h2 id="anime-title">Carregando...</h2>
        <button class="btn-back" onclick="window.location.href='content.html'">
          ‚Üê Voltar
        </button>
      </div>

      <div class="video-container">
        <iframe
          id="video-player"
          src=""
          frameborder="0"
          allowfullscreen
        ></iframe>
      </div>

      <div class="player-controls">
        <div class="episodes-panel">
          <h3>üì∫ Epis√≥dios</h3>
          <div id="episodes-list" class="episodes-list">
            <div class="loading-message">Carregando epis√≥dios...</div>
          </div>
        </div>

        <div class="info-panel">
          <h3>‚ÑπÔ∏è Informa√ß√µes</h3>
          <div id="anime-info">
            <div class="loading-message">Carregando informa√ß√µes...</div>
          </div>
        </div>
      </div>
    </div>

    <script src="api-service.js"></script>
    <script>
      // ===========================
      // VARI√ÅVEIS GLOBAIS
      // ===========================

      let currentAnimeId = null;
      let currentEpisodeNumber = 1;
      let currentEpisodes = [];
      let animeInfo = null;

      // ===========================
      // OBTER PAR√ÇMETROS DA URL
      // ===========================

      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id"),
          ep: parseInt(params.get("ep")) || 1,
        };
      }

      // ===========================
      // AGUARDAR API
      // ===========================

      function waitForAPI() {
        return new Promise((resolve, reject) => {
          if (window.AnimeAPI) {
            console.log("‚úÖ API dispon√≠vel");
            resolve();
            return;
          }

          console.log("‚è≥ Aguardando API...");
          let attempts = 0;
          const maxAttempts = 100;

          const checkInterval = setInterval(() => {
            attempts++;

            if (window.AnimeAPI) {
              clearInterval(checkInterval);
              console.log(`‚úÖ API carregada ap√≥s ${attempts * 100}ms`);
              resolve();
            } else if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              reject(new Error("API n√£o carregou a tempo"));
            }
          }, 100);
        });
      }

      // ===========================
      // CARREGAR ANIME
      // ===========================

      async function loadAnime(animeId, episodeNumber) {
        console.log(
          `üì° Carregando anime: ${animeId}, epis√≥dio: ${episodeNumber}`
        );

        try {
          // Carregar informa√ß√µes do anime
          console.log("üì° Buscando informa√ß√µes...");
          const infoData = await window.AnimeAPI.getAnimeInfo(animeId);
          animeInfo = infoData.anime?.info || infoData;

          console.log("‚úÖ Info carregada:", animeInfo);

          // Atualizar t√≠tulo
          const title = animeInfo.name || animeInfo.title || "Anime";
          document.getElementById(
            "anime-title"
          ).textContent = `${title} - EP ${episodeNumber}`;

          // Exibir informa√ß√µes
          displayAnimeInfo(animeInfo);

          // Carregar epis√≥dios
          console.log("üì° Buscando epis√≥dios...");
          const episodesData = await window.AnimeAPI.getAnimeEpisodes(animeId);
          currentEpisodes = episodesData.episodes || [];

          console.log(`‚úÖ ${currentEpisodes.length} epis√≥dios carregados`);

          // Renderizar lista de epis√≥dios
          renderEpisodes(currentEpisodes, episodeNumber);

          // Carregar epis√≥dio atual
          const currentEpisode = currentEpisodes.find(
            (ep) => ep.number === episodeNumber
          );
          if (currentEpisode) {
            await loadEpisode(
              currentEpisode.episodeId,
              episodeNumber,
              currentEpisode.title
            );
          } else {
            throw new Error(`Epis√≥dio ${episodeNumber} n√£o encontrado`);
          }
        } catch (error) {
          console.error("‚ùå Erro ao carregar anime:", error);
          showError(`Erro ao carregar: ${error.message}`);
        }
      }

      // ===========================
      // CARREGAR EPIS√ìDIO
      // ===========================

      async function loadEpisode(episodeId, episodeNumber, episodeTitle) {
        console.log(`üì° Carregando epis√≥dio: ${episodeId}`);

        try {
          // Buscar servidores
          const serversData = await window.AnimeAPI.getEpisodeServers(
            episodeId
          );
          const servers = serversData.servers || [];

          console.log("‚úÖ Servidores dispon√≠veis:", servers);

          if (servers.length === 0) {
            throw new Error("Nenhum servidor dispon√≠vel");
          }

          // Pegar o primeiro servidor dispon√≠vel
          const server = servers[0];

          // Buscar links de streaming
          const streamsData = await window.AnimeAPI.getEpisodeStreams(
            episodeId,
            server.serverName || "hd-1",
            "sub"
          );

          console.log("‚úÖ Streams recebidos:", streamsData);

          // Extrair URL do v√≠deo
          const videoUrl =
            streamsData.sources?.[0]?.url ||
            streamsData.link ||
            streamsData.url;

          if (!videoUrl) {
            throw new Error("URL do v√≠deo n√£o encontrada");
          }

          console.log("‚úÖ URL do v√≠deo:", videoUrl);

          // Carregar v√≠deo no player
          const videoPlayer = document.getElementById("video-player");
          videoPlayer.src = videoUrl;

          // Atualizar t√≠tulo
          const title = animeInfo?.name || animeInfo?.title || "Anime";
          document.getElementById(
            "anime-title"
          ).textContent = `${title} - EP ${episodeNumber}${
            episodeTitle ? `: ${episodeTitle}` : ""
          }`;

          // Atualizar bot√£o ativo
          document.querySelectorAll(".episode-btn").forEach((btn) => {
            btn.classList.remove("active");
            if (parseInt(btn.dataset.episode) === episodeNumber) {
              btn.classList.add("active");
            }
          });

          // Atualizar URL sem recarregar
          const newUrl = `player.html?id=${encodeURIComponent(
            currentAnimeId
          )}&ep=${episodeNumber}`;
          window.history.pushState({}, "", newUrl);

          // Salvar no hist√≥rico
          saveToHistory(currentAnimeId, title, episodeNumber);
        } catch (error) {
          console.error("‚ùå Erro ao carregar epis√≥dio:", error);
          showError(`Erro ao carregar epis√≥dio: ${error.message}`);
        }
      }

      // ===========================
      // RENDERIZAR EPIS√ìDIOS
      // ===========================

      function renderEpisodes(episodes, currentEp) {
        const container = document.getElementById("episodes-list");

        if (episodes.length === 0) {
          container.innerHTML =
            '<p style="color: #9ca3af;">Nenhum epis√≥dio dispon√≠vel</p>';
          return;
        }

        container.innerHTML = episodes
          .map(
            (ep) => `
        <button 
          class="episode-btn ${ep.number === currentEp ? "active" : ""}" 
          data-episode="${ep.number}"
          onclick="selectEpisode('${ep.episodeId}', ${ep.number}, '${escapeHtml(
              ep.title || ""
            )}')"
        >
          EP ${ep.number}
        </button>
      `
          )
          .join("");
      }

      // ===========================
      // SELECIONAR EPIS√ìDIO
      // ===========================

      function selectEpisode(episodeId, episodeNumber, episodeTitle) {
        currentEpisodeNumber = episodeNumber;
        loadEpisode(episodeId, episodeNumber, episodeTitle);
      }

      // ===========================
      // EXIBIR INFORMA√á√ïES
      // ===========================

      function displayAnimeInfo(info) {
        const container = document.getElementById("anime-info");

        container.innerHTML = `
        <div style="line-height: 1.8;">
          <p><strong>Nome:</strong> ${escapeHtml(
            info.name || info.title || "N/A"
          )}</p>
          ${
            info.jname
              ? `<p><strong>Nome JP:</strong> ${escapeHtml(info.jname)}</p>`
              : ""
          }
          <p><strong>‚≠ê Rating:</strong> ${info.rating || "N/A"}</p>
          ${
            info.stats?.episodes?.sub
              ? `<p><strong>üì∫ Epis√≥dios:</strong> ${info.stats.episodes.sub}</p>`
              : ""
          }
          ${
            info.stats?.type
              ? `<p><strong>üìÖ Tipo:</strong> ${info.stats.type}</p>`
              : ""
          }
          ${
            info.stats?.status
              ? `<p><strong>Status:</strong> ${info.stats.status}</p>`
              : ""
          }
          ${
            info.description
              ? `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #334155;">
              <p style="color: #9ca3af; line-height: 1.6;">${escapeHtml(
                info.description
              ).substring(0, 300)}...</p>
            </div>
          `
              : ""
          }
        </div>
      `;
      }

      // ===========================
      // SALVAR NO HIST√ìRICO
      // ===========================

      function saveToHistory(animeId, animeTitle, episodeNumber) {
        const history = JSON.parse(
          localStorage.getItem("watch_history") || "[]"
        );

        const existingIndex = history.findIndex((item) => item.id === animeId);

        const historyItem = {
          id: animeId,
          title: animeTitle,
          image: animeInfo?.poster || "",
          episode: episodeNumber,
          progress: 0,
          lastWatched: new Date().toISOString(),
          type: "anime",
        };

        if (existingIndex >= 0) {
          history[existingIndex] = historyItem;
        } else {
          history.unshift(historyItem);
        }

        // Manter apenas os 20 mais recentes
        if (history.length > 20) {
          history.splice(20);
        }

        localStorage.setItem("watch_history", JSON.stringify(history));
      }

      // ===========================
      // UTILIT√ÅRIOS
      // ===========================

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showError(message) {
        const container = document.querySelector(".player-container");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.innerHTML = `
        <h3>‚ùå Erro</h3>
        <p>${message}</p>
        <button onclick="window.location.reload()" class="btn-back" style="margin-top: 10px;">
          üîÑ Tentar Novamente
        </button>
      `;
        container.insertBefore(errorDiv, container.firstChild);
      }

      // ===========================
      // INICIALIZA√á√ÉO
      // ===========================

      (async function init() {
        console.log("üé¨ Iniciando player...");

        try {
          // Obter par√¢metros da URL
          const params = getUrlParams();

          if (!params.id) {
            throw new Error("ID do anime n√£o fornecido na URL");
          }

          currentAnimeId = params.id;
          currentEpisodeNumber = params.ep;

          console.log(`üìå Anime ID: ${currentAnimeId}`);
          console.log(`üìå Epis√≥dio: ${currentEpisodeNumber}`);

          // Aguardar API carregar
          await waitForAPI();

          // Carregar anime
          await loadAnime(currentAnimeId, currentEpisodeNumber);
        } catch (error) {
          console.error("‚ùå Erro na inicializa√ß√£o:", error);
          showError(`Falha ao inicializar: ${error.message}`);
        }
      })();

      // ===========================
      // NAVEGA√á√ÉO DO HIST√ìRICO
      // ===========================

      window.addEventListener("popstate", function () {
        const params = getUrlParams();
        if (params.id && params.ep) {
          const episode = currentEpisodes.find((ep) => ep.number === params.ep);
          if (episode) {
            loadEpisode(episode.episodeId, params.ep, episode.title);
          }
        }
      });

      // Expor fun√ß√µes globalmente
      window.selectEpisode = selectEpisode;
    </script>
  </body>
</html>
