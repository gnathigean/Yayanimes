<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player - YayaAnimes</title>

    <!-- CSS -->
    <link rel="stylesheet" href="streaming.css" />
    <link rel="stylesheet" href="plyr-custom.css" />

    <!-- Plyr.js -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
      /* Estilos do Loading */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        gap: 20px;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(102, 126, 234, 0.2);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Estilos do Error */
      .error-container {
        background: rgba(239, 68, 68, 0.1);
        border: 2px solid #ef4444;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        margin: 20px;
      }

      .error-container h2 {
        color: #ef4444;
        margin-bottom: 15px;
      }

      .error-container p {
        color: #9ca3af;
        margin-bottom: 20px;
      }

      /* Player Controls Customization */
      .player-controls-wrapper {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .controls-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .control-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .control-label {
        color: #9ca3af;
        font-size: 14px;
        font-weight: 600;
      }

      .server-btn,
      .category-btn {
        padding: 8px 16px;
        border: 2px solid #334155;
        background: #0f172a;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 600;
      }

      .server-btn:hover,
      .category-btn:hover {
        border-color: #667eea;
        background: #1e293b;
      }

      .server-btn.active,
      .category-btn.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
      }

      /* Episode List */
      .episodes-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }

      .episode-btn {
        padding: 12px;
        background: #1e293b;
        border: 2px solid #334155;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .episode-btn:hover {
        border-color: #667eea;
        transform: translateY(-2px);
      }

      .episode-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      /* Anime Info */
      .anime-info-section {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .anime-info-section h2 {
        color: white;
        margin-bottom: 10px;
      }

      .anime-info-section p {
        color: #9ca3af;
        line-height: 1.6;
      }

      .anime-meta {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #9ca3af;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="streaming-header">
      <div class="header-content">
        <div class="logo-section">
          <a href="content.html" class="logo-link">
            <img src="assets/logo.png" alt="YayaAnimes" class="main-logo" />
          </a>
        </div>

        <nav class="main-nav">
          <a href="content.html" class="nav-btn">üè† In√≠cio</a>
        </nav>

        <div class="user-section">
          <span class="user-email" id="user-email">usu√°rio@email.com</span>
          <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="content-main">
      <!-- Loading State -->
      <div id="loading-state" class="loading-container">
        <div class="loading-spinner"></div>
        <p style="color: #9ca3af">Carregando player...</p>
      </div>

      <!-- Error State -->
      <div id="error-state" class="error-container" style="display: none">
        <h2>‚ùå Oops! Algo deu errado</h2>
        <p id="error-message">Erro desconhecido</p>
        <button class="btn-primary" onclick="retryLoad()">
          üîÑ Tentar Novamente
        </button>
      </div>

      <!-- Player Container -->
      <div id="player-container" style="display: none">
        <!-- Anime Info -->
        <div id="anime-info" class="anime-info-section"></div>

        <!-- Player Controls -->
        <div id="player-controls" class="player-controls-wrapper"></div>

        <!-- Video Player -->
        <div class="video-wrapper">
          <video id="player" controls playsinline></video>
        </div>

        <!-- Episodes List -->
        <div class="anime-info-section">
          <h2>üì∫ Epis√≥dios</h2>
          <div id="episodes-list" class="episodes-list"></div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="streaming-footer">
      <div class="footer-content">
        <p>¬© 2025 YayaAnimes - Todos os direitos reservados</p>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="api-service.js"></script>

    <script>
      // ==================== VARI√ÅVEIS GLOBAIS ====================
      let player = null;
      let hls = null;
      let currentAnimeData = null;
      let currentEpisodes = [];
      let currentEpisodeNumber = 1;
      let episodeServers = { sub: [], dub: [], raw: [] };
      let currentServer = null;
      let currentCategory = 'sub';

      // ==================== VERIFICA√á√ÉO DA API ====================
      if (typeof api === 'undefined') {
        console.error('‚ùå API Service n√£o carregado!');
        showError('Erro ao carregar servi√ßo de API');
      } else {
        console.log('‚úÖ API dispon√≠vel');
      }

      // ==================== FUN√á√ïES DE UI ====================

      function showLoading() {
        document.getElementById('loading-state').style.display = 'flex';
        document.getElementById('error-state').style.display = 'none';
        document.getElementById('player-container').style.display = 'none';
      }

      function hideLoading() {
        document.getElementById('loading-state').style.display = 'none';
      }

      function showError(message) {
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-state').style.display = 'block';
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('player-container').style.display = 'none';
      }

      function hideError() {
        document.getElementById('error-state').style.display = 'none';
      }

      function showPlayer() {
        document.getElementById('player-container').style.display = 'block';
      }

      // ==================== FUN√á√ïES PRINCIPAIS ====================

      // Fun√ß√£o para carregar informa√ß√µes do anime
      async function loadAnime(animeId, episodeNumber) {
        console.log('üì° Carregando anime:', animeId, 'epis√≥dio:', episodeNumber);

        try {
          hideError();
          showLoading();

          // Buscar informa√ß√µes do anime
          console.log('üì° Buscando informa√ß√µes...');
          const animeInfo = await api.getAnimeInfo(animeId);
          console.log('‚úÖ Info carregada:', animeInfo);

          if (!animeInfo) {
            throw new Error('Informa√ß√µes do anime n√£o encontradas');
          }

          currentAnimeData = animeInfo;

          // Renderizar informa√ß√µes do anime
          renderAnimeInfo(animeInfo);

          // Buscar epis√≥dios
          console.log('üì° Buscando epis√≥dios...');
          const episodesData = await api.getAnimeEpisodes(animeId);
          console.log('üì¶ Dados de epis√≥dios recebidos:', episodesData);

          const episodes = episodesData.episodes || [];
          console.log('‚úÖ Epis√≥dios carregados:', episodes.length, episodes);

          if (episodes.length === 0) {
            throw new Error('Nenhum epis√≥dio encontrado para este anime');
          }

          currentEpisodes = episodes;
          currentEpisodeNumber = episodeNumber;

          // Renderizar lista de epis√≥dios
          renderEpisodeList(episodes, episodeNumber);

          // Encontrar epis√≥dio atual
          const currentEpisode = episodes.find(ep => ep.number === episodeNumber);

          if (!currentEpisode) {
            throw new Error(`Epis√≥dio ${episodeNumber} n√£o encontrado`);
          }

          console.log('üéØ Epis√≥dio encontrado:', currentEpisode);

          // ‚úÖ CORRE√á√ÉO: Usar o episodeId COMPLETO sem modifica√ß√µes
          const episodeIdToLoad = currentEpisode.episodeId;
          console.log('üéØ EpisodeId completo a ser carregado:', episodeIdToLoad);

          // Carregar o epis√≥dio
          await loadEpisode(episodeIdToLoad);

          hideLoading();
          showPlayer();

        } catch (error) {
          console.error('‚ùå Erro ao carregar anime:', error);
          hideLoading();
          showError(`Erro ao carregar anime: ${error.message}`);
        }
      }

      // ‚úÖ FUN√á√ÉO CORRIGIDA - N√£o modificar o episodeId
      async function loadEpisode(episodeId) {
        console.log('==================');
        console.log('üîç DEBUG loadEpisode');
        console.log('üìå EpisodeId recebido:', episodeId);
        console.log('üìå Tipo:', typeof episodeId);
        console.log('üìå Comprimento:', episodeId?.length);
        console.log('==================');

        if (!episodeId || typeof episodeId !== 'string') {
          console.error('‚ùå EpisodeId inv√°lido:', episodeId);
          showError('ID do epis√≥dio inv√°lido');
          return;
        }

        // Verificar se tem o formato correto
        if (!episodeId.includes('?ep=')) {
          console.warn('‚ö†Ô∏è EpisodeId pode estar incorreto (falta ?ep=)');
        }

        try {
          // ‚úÖ USAR O EPISODEID COMPLETO SEM MODIFICA√á√ïES
          console.log('üì° Chamando getEpisodeServers com:', episodeId);
          const serversData = await api.getEpisodeServers(episodeId);
          console.log('‚úÖ Servidores carregados:', serversData);

          if (!serversData) {
            throw new Error('Dados de servidores n√£o encontrados');
          }

          // Armazenar dados dos servidores
          episodeServers = {
            sub: serversData.sub || [],
            dub: serversData.dub || [],
            raw: serversData.raw || []
          };

          console.log('üì¶ Servidores dispon√≠veis:', episodeServers);

          // Renderizar controles de servidor
          renderServerControls();

          // Selecionar categoria padr√£o
          const defaultCategory = episodeServers.sub?.length > 0 ? 'sub' :
                                 episodeServers.dub?.length > 0 ? 'dub' : 'raw';

          if (episodeServers[defaultCategory]?.length > 0) {
            currentCategory = defaultCategory;
            currentServer = episodeServers[defaultCategory][0].serverName;

            console.log(`üéØ Categoria selecionada: ${currentCategory}`);
            console.log(`üéØ Servidor selecionado: ${currentServer}`);

            // ‚úÖ PASSAR O EPISODEID COMPLETO
            await loadVideoSources(episodeId, currentServer, currentCategory);
          } else {
            throw new Error('Nenhum servidor dispon√≠vel para este epis√≥dio');
          }

        } catch (error) {
          console.error('‚ùå Erro ao carregar epis√≥dio:', error);
          showError(`Erro ao carregar epis√≥dio: ${error.message}`);
        }
      }

      // ‚úÖ FUN√á√ÉO CORRIGIDA - Receber episodeId como par√¢metro
      async function loadVideoSources(episodeId, server, category) {
        console.log('üì° Carregando fontes de v√≠deo...');
        console.log('üìå EpisodeId:', episodeId);
        console.log('üìå Server:', server);
        console.log('üìå Category:', category);

        try {
          // ‚úÖ USAR O EPISODEID COMPLETO
          const sources = await api.getEpisodeSources(episodeId, server, category);
          console.log('‚úÖ Fontes carregadas:', sources);

          if (!sources || !sources.sources || sources.sources.length === 0) {
            throw new Error('Nenhuma fonte de v√≠deo encontrada');
          }

          // Inicializar player com HLS
          initializePlayer(sources);

        } catch (error) {
          console.error('‚ùå Erro ao carregar fontes:', error);
          showError(`Erro ao carregar v√≠deo: ${error.message}`);
        }
      }

      // Inicializar player com HLS.js
      function initializePlayer(sources) {
        console.log('üé¨ Inicializando player...');

        const videoElement = document.getElementById('player');
        const videoUrl = sources.sources[0].url;

        console.log('üì∫ URL do v√≠deo:', videoUrl);

        // Destruir inst√¢ncias anteriores
        if (hls) {
          hls.destroy();
        }
        if (player) {
          player.destroy();
        }

        // Verificar se √© M3U8
        if (sources.sources[0].isM3U8) {
          if (Hls.isSupported()) {
            hls = new Hls({
              xhrSetup: function (xhr, url) {
                // Adicionar headers customizados se necess√°rio
                if (sources.headers) {
                  Object.keys(sources.headers).forEach(key => {
                    xhr.setRequestHeader(key, sources.headers[key]);
                  });
                }
              }
            });

            hls.loadSource(videoUrl);
            hls.attachMedia(videoElement);

            hls.on(Hls.Events.MANIFEST_PARSED, function () {
              console.log('‚úÖ Manifesto HLS carregado');
              
              // Inicializar Plyr
              player = new Plyr(videoElement, {
                controls: [
                  'play-large',
                  'play',
                  'progress',
                  'current-time',
                  'mute',
                  'volume',
                  'settings',
                  'fullscreen'
                ],
                settings: ['quality', 'speed'],
                quality: {
                  default: 'auto',
                  options: hls.levels.map((level) => level.height)
                }
              });

              videoElement.play();
            });

            hls.on(Hls.Events.ERROR, function (event, data) {
              console.error('‚ùå Erro HLS:', data);
              if (data.fatal) {
                switch (data.type) {
                  case Hls.ErrorTypes.NETWORK_ERROR:
                    console.error('Erro de rede, tentando recuperar...');
                    hls.startLoad();
                    break;
                  case Hls.ErrorTypes.MEDIA_ERROR:
                    console.error('Erro de m√≠dia, tentando recuperar...');
                    hls.recoverMediaError();
                    break;
                  default:
                    showError('Erro fatal ao carregar v√≠deo');
                    hls.destroy();
                    break;
                }
              }
            });

          } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
            // Suporte nativo (Safari)
            videoElement.src = videoUrl;
            player = new Plyr(videoElement);
            videoElement.play();
          } else {
            showError('HLS n√£o √© suportado neste navegador');
          }
        } else {
          // V√≠deo MP4 direto
          videoElement.src = videoUrl;
          player = new Plyr(videoElement);
          videoElement.play();
        }
      }

      // ==================== RENDERIZA√á√ÉO ====================

      function renderAnimeInfo(animeInfo) {
        const info = animeInfo.anime.info;
        const moreInfo = animeInfo.anime.moreInfo;

        document.getElementById('anime-info').innerHTML = `
          <h2>${info.name}</h2>
          <p>${info.description || 'Sem descri√ß√£o dispon√≠vel'}</p>
          <div class="anime-meta">
            <span class="meta-item">‚≠ê ${info.stats.rating}</span>
            <span class="meta-item">üì∫ ${info.stats.type}</span>
            <span class="meta-item">‚è±Ô∏è ${info.stats.duration}</span>
            <span class="meta-item">üé¨ ${moreInfo.status}</span>
            ${moreInfo.studios ? `<span class="meta-item">üè¢ ${moreInfo.studios}</span>` : ''}
          </div>
        `;
      }

      function renderServerControls() {
        const controlsHtml = `
          <div class="controls-row">
            <!-- Category Selection -->
            <div class="control-group">
              <span class="control-label">Idioma:</span>
              ${episodeServers.sub?.length > 0 ? `
                <button class="category-btn ${currentCategory === 'sub' ? 'active' : ''}" 
                        onclick="changeCategory('sub')">
                  Legendado (${episodeServers.sub.length})
                </button>
              ` : ''}
              ${episodeServers.dub?.length > 0 ? `
                <button class="category-btn ${currentCategory === 'dub' ? 'active' : ''}" 
                        onclick="changeCategory('dub')">
                  Dublado (${episodeServers.dub.length})
                </button>
              ` : ''}
              ${episodeServers.raw?.length > 0 ? `
                <button class="category-btn ${currentCategory === 'raw' ? 'active' : ''}" 
                        onclick="changeCategory('raw')">
                  RAW (${episodeServers.raw.length})
                </button>
              ` : ''}
            </div>

            <!-- Server Selection -->
            <div class="control-group">
              <span class="control-label">Servidor:</span>
              ${episodeServers[currentCategory]?.map(server => `
                <button class="server-btn ${currentServer === server.serverName ? 'active' : ''}" 
                        onclick="changeServer('${server.serverName}')">
                  ${server.serverName}
                </button>
              `).join('')}
            </div>
          </div>
        `;

        document.getElementById('player-controls').innerHTML = controlsHtml;
      }

      function renderEpisodeList(episodes, currentEp) {
        const listHtml = episodes.map(ep => `
          <button class="episode-btn ${ep.number === currentEp ? 'active' : ''}"
                  onclick="changeEpisode(${ep.number})">
            EP ${ep.number}
          </button>
        `).join('');

        document.getElementById('episodes-list').innerHTML = listHtml;
      }

      // ==================== CONTROLES DE NAVEGA√á√ÉO ====================

      function changeCategory(category) {
        currentCategory = category;
        
        if (episodeServers[category]?.length > 0) {
          currentServer = episodeServers[category][0].serverName;
          renderServerControls();
          
          // Recarregar v√≠deo com nova categoria
          const currentEpisode = currentEpisodes.find(ep => ep.number === currentEpisodeNumber);
          if (currentEpisode) {
            loadVideoSources(currentEpisode.episodeId, currentServer, currentCategory);
          }
        }
      }

      function changeServer(serverName) {
        currentServer = serverName;
        renderServerControls();
        
        // Recarregar v√≠deo com novo servidor
        const currentEpisode = currentEpisodes.find(ep => ep.number === currentEpisodeNumber);
        if (currentEpisode) {
          loadVideoSources(currentEpisode.episodeId, serverName, currentCategory);
        }
      }

      function changeEpisode(episodeNumber) {
        const urlParams = new URLSearchParams(window.location.search);
        const animeId = urlParams.get('id');
        
        // Atualizar URL
        window.history.pushState({}, '', `player.html?id=${animeId}&ep=${episodeNumber}`);
        
        // Recarregar anime com novo epis√≥dio
        loadAnime(animeId, episodeNumber);
      }

      function retryLoad() {
        location.reload();
      }

      async function logout() {
        try {
          const { error } = await window.supabase.auth.signOut();
          if (error) throw error;
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Erro ao fazer logout:', error);
        }
      }

      // ==================== INICIALIZA√á√ÉO ====================

      async function init() {
        console.log('üé¨ Iniciando player...');

        try {
          // Verificar autentica√ß√£o
          const user = await checkAuth();
          if (!user) {
            window.location.href = 'index.html';
            return;
          }

          document.getElementById('user-email').textContent = user.email;

          // Pegar par√¢metros da URL
          const urlParams = new URLSearchParams(window.location.search);
          const animeId = urlParams.get('id');
          const episodeNumber = parseInt(urlParams.get('ep')) || 1;

          console.log('üìå Anime ID:', animeId);
          console.log('üìå Epis√≥dio:', episodeNumber);

          if (!animeId) {
            showError('ID do anime n√£o especificado na URL');
            return;
          }

          // Carregar anime
          await loadAnime(animeId, episodeNumber);

        } catch (error) {
          console.error('‚ùå Erro na inicializa√ß√£o:', error);
          showError(`Erro na inicializa√ß√£o: ${error.message}`);
        }
      }

      // Iniciar quando o DOM estiver pronto
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>