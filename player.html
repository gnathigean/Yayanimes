<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player - YayaAnimes</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 15px 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        color: white;
        font-size: 24px;
      }

      .btn-back {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-back:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
      }

      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }

      .player-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .player-container {
        background: #1a1a2e;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .video-wrapper {
        position: relative;
        padding-top: 56.25%;
        background: #000;
      }

      .video-wrapper video,
      .video-wrapper iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .player-info {
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
      }

      .anime-title {
        color: white;
        font-size: 24px;
        margin-bottom: 5px;
      }

      .anime-jname {
        color: #9ca3af;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .episode-title {
        color: #d1d5db;
        font-size: 16px;
      }

      .servers-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
      }

      .servers-section h3 {
        color: white;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .server-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .tab-btn {
        flex: 1;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .tab-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      .server-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
      }

      .server-btn {
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
      }

      .server-btn:hover {
        border-color: #667eea;
      }

      .server-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      .episodes-sidebar {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
      }

      .episodes-sidebar h3 {
        color: white;
        margin-bottom: 15px;
      }

      .episodes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
      }

      .episode-btn {
        padding: 12px 8px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 13px;
        font-weight: 600;
      }

      .episode-btn:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.2);
      }

      .episode-btn.active {
        background: #667eea;
        border-color: #667eea;
      }

      .episode-btn.filler {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.3);
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: white;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .message {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .message.error {
        background: rgba(239, 68, 68, 0.2);
        border: 2px solid #ef4444;
        color: white;
      }

      .message.success {
        background: rgba(16, 185, 129, 0.2);
        border: 2px solid #10b981;
        color: white;
      }

      .placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: white;
        flex-direction: column;
        gap: 15px;
      }

      .placeholder-icon {
        font-size: 64px;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üé¨ YayaAnimes Player</h1>
        <button class="btn-back" onclick="window.location.href='content.html'">
          ‚Üê Voltar
        </button>
      </div>

      <div class="main-content">
        <!-- Player Section -->
        <div class="player-section">
          <!-- Video Player -->
          <div class="player-container">
            <div class="video-wrapper">
              <div id="loading" class="loading" style="display: none">
                <div class="loading-spinner"></div>
                <p>Carregando epis√≥dio...</p>
              </div>
              <div id="placeholder" class="placeholder">
                <div class="placeholder-icon">üé¨</div>
                <p>Carregando anime...</p>
              </div>
              <video id="video-player" controls style="display: none"></video>
            </div>
            <div class="player-info">
              <h2 class="anime-title" id="anime-title">--</h2>
              <p class="anime-jname" id="anime-jname">--</p>
              <p class="episode-title" id="episode-title">--</p>
            </div>
          </div>

          <!-- Servers -->
          <div class="servers-section">
            <h3>üåê Servidores de Streaming</h3>

            <div class="server-tabs">
              <button
                class="tab-btn active"
                data-category="sub"
                onclick="switchCategory('sub')"
              >
                Legendado
              </button>
              <button
                class="tab-btn"
                data-category="dub"
                onclick="switchCategory('dub')"
              >
                Dublado
              </button>
              <button
                class="tab-btn"
                data-category="raw"
                onclick="switchCategory('raw')"
              >
                RAW
              </button>
            </div>

            <div id="servers-container" class="server-list">
              <p
                style="
                  color: #9ca3af;
                  grid-column: 1/-1;
                  text-align: center;
                  padding: 20px;
                "
              >
                Selecione um epis√≥dio
              </p>
            </div>
          </div>

          <div id="message-container"></div>
        </div>

        <!-- Episodes Sidebar -->
        <div class="episodes-sidebar">
          <h3>üì∫ Epis√≥dios</h3>
          <div id="episodes-container" class="episodes-grid">
            <p style="color: #9ca3af; text-align: center; padding: 20px">
              Carregando...
            </p>
          </div>
        </div>
      </div>
    </div>

    <script src="api-service.js"></script>
    <script>
      let currentAnime = null;
      let currentEpisodes = [];
      let currentEpisodeId = null;
      let currentServers = null;
      let currentCategory = "sub";

      // Extrair par√¢metros da URL
      const urlParams = new URLSearchParams(window.location.search);
      const animeId = urlParams.get("id");
      const episodeNumber = parseInt(urlParams.get("ep") || "1");

      // Inicializar
      if (animeId) {
        loadAnime(animeId, episodeNumber);
      } else {
        showMessage("‚ùå ID do anime n√£o fornecido", "error");
      }

      async function loadAnime(animeId, episodeNum = 1) {
        try {
          showLoading();

          // Carregar informa√ß√µes do anime e epis√≥dios
          const [animeData, episodesData] = await Promise.all([
            window.AnimeAPI.getAnimeInfo(animeId),
            window.AnimeAPI.getAnimeEpisodes(animeId),
          ]);

          currentAnime = animeData.anime.info;
          currentEpisodes = episodesData.episodes || [];

          // Atualizar informa√ß√µes do anime
          document.getElementById("anime-title").textContent =
            currentAnime.name;
          document.getElementById("anime-jname").textContent =
            currentAnime.jname || "";

          // Renderizar lista de epis√≥dios
          renderEpisodes(currentEpisodes, episodeNum);

          // Carregar epis√≥dio atual
          const episode =
            currentEpisodes.find((ep) => ep.number === episodeNum) ||
            currentEpisodes[0];
          if (episode) {
            loadEpisode(episode.episodeId, episodeNum, episode.title);
          }

          hideLoading();
        } catch (error) {
          console.error("Erro ao carregar anime:", error);
          showMessage(`‚ùå Erro ao carregar anime: ${error.message}`, "error");
          hideLoading();
        }
      }

      function renderEpisodes(episodes, currentEp) {
        const container = document.getElementById("episodes-container");

        if (episodes.length === 0) {
          container.innerHTML =
            '<p style="color: #9ca3af; text-align: center; padding: 20px;">Nenhum epis√≥dio dispon√≠vel</p>';
          return;
        }

        container.innerHTML = episodes
          .map(
            (ep) => `
        <button 
          class="episode-btn ${ep.number === currentEp ? "active" : ""} ${
              ep.isFiller ? "filler" : ""
            }"
          onclick="selectEpisode('${ep.episodeId}', ${ep.number}, '${
              ep.title || "Epis√≥dio " + ep.number
            }')"
          title="${ep.title || "Epis√≥dio " + ep.number}${
              ep.isFiller ? " (Filler)" : ""
            }"
        >
          ${ep.number}
        </button>
      `
          )
          .join("");
      }

      async function selectEpisode(episodeId, episodeNum, title) {
        // Atualizar URL
        const newUrl = `${window.location.pathname}?id=${animeId}&ep=${episodeNum}`;
        window.history.pushState({}, "", newUrl);

        // Atualizar classe active
        document
          .querySelectorAll(".episode-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        await loadEpisode(episodeId, episodeNum, title);
      }

      async function loadEpisode(episodeId, episodeNum, title) {
        try {
          currentEpisodeId = episodeId;

          document.getElementById(
            "episode-title"
          ).textContent = `Epis√≥dio ${episodeNum}: ${title}`;

          showVideoLoading();

          // Carregar servidores dispon√≠veis
          const serversData = await window.AnimeAPI.getEpisodeServers(
            episodeId
          );
          currentServers = serversData;

          renderServers(currentServers, currentCategory);

          // Carregar primeiro servidor dispon√≠vel
          const servers = currentServers[currentCategory] || [];
          if (servers.length > 0) {
            await loadServer(servers[0].serverName, currentCategory);
          } else {
            showMessage(
              `‚ö†Ô∏è Nenhum servidor dispon√≠vel para ${getCategoryName(
                currentCategory
              )}`,
              "error"
            );
            hideVideoLoading();
          }
        } catch (error) {
          console.error("Erro ao carregar epis√≥dio:", error);
          showMessage(
            `‚ùå Erro ao carregar epis√≥dio: ${error.message}`,
            "error"
          );
          hideVideoLoading();
        }
      }

      function renderServers(servers, category) {
        const container = document.getElementById("servers-container");
        const serverList = servers[category] || [];

        if (serverList.length === 0) {
          container.innerHTML = `
          <p style="color: #9ca3af; grid-column: 1/-1; text-align: center; padding: 20px;">
            Nenhum servidor dispon√≠vel para ${getCategoryName(category)}
          </p>
        `;
          return;
        }

        container.innerHTML = serverList
          .map(
            (server, index) => `
        <button 
          class="server-btn ${index === 0 ? "active" : ""}"
          onclick="loadServer('${server.serverName}', '${category}')"
          data-server="${server.serverName}"
        >
          ${server.serverName}
        </button>
      `
          )
          .join("");
      }

      async function loadServer(serverName, category) {
        try {
          // Atualizar classe active
          document
            .querySelectorAll(".server-btn")
            .forEach((btn) => btn.classList.remove("active"));
          const activeBtn = document.querySelector(
            `[data-server="${serverName}"]`
          );
          if (activeBtn) activeBtn.classList.add("active");

          showVideoLoading();

          // Buscar streams
          const streams = await window.AnimeAPI.getEpisodeStreams(
            currentEpisodeId,
            serverName,
            category
          );

          if (!streams || !streams.sources || streams.sources.length === 0) {
            showMessage("‚ùå Nenhuma fonte de v√≠deo dispon√≠vel", "error");
            hideVideoLoading();
            return;
          }

          // Pegar a melhor qualidade dispon√≠vel
          const source = streams.sources[0];

          const videoPlayer = document.getElementById("video-player");
          const placeholder = document.getElementById("placeholder");

          if (source.isM3U8) {
            // √â um stream HLS (.m3u8)
            if (Hls.isSupported()) {
              const hls = new Hls();
              hls.loadSource(source.url);
              hls.attachMedia(videoPlayer);

              hls.on(Hls.Events.MANIFEST_PARSED, () => {
                videoPlayer
                  .play()
                  .catch((e) => console.log("Autoplay bloqueado"));
              });

              hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                  console.error("Erro fatal no HLS:", data);
                  showMessage("‚ùå Erro ao carregar v√≠deo", "error");
                }
              });
            } else if (
              videoPlayer.canPlayType("application/vnd.apple.mpegurl")
            ) {
              // Safari nativo
              videoPlayer.src = source.url;
              videoPlayer.addEventListener("loadedmetadata", () => {
                videoPlayer
                  .play()
                  .catch((e) => console.log("Autoplay bloqueado"));
              });
            } else {
              showMessage(
                "‚ùå Seu navegador n√£o suporta streaming HLS",
                "error"
              );
              hideVideoLoading();
              return;
            }
          } else {
            // V√≠deo direto (MP4, etc)
            videoPlayer.src = source.url;
            videoPlayer.play().catch((e) => console.log("Autoplay bloqueado"));
          }

          // Adicionar legendas se dispon√≠veis
          if (streams.subtitles && streams.subtitles.length > 0) {
            videoPlayer.innerHTML = streams.subtitles
              .map(
                (sub) => `
            <track 
              kind="subtitles" 
              src="${sub.url}" 
              srclang="${sub.lang || "en"}" 
              label="${sub.lang || "English"}"
            >
          `
              )
              .join("");
          }

          placeholder.style.display = "none";
          videoPlayer.style.display = "block";
          hideVideoLoading();

          showMessage(`‚úÖ Reproduzindo via ${serverName}`, "success");
        } catch (error) {
          console.error("Erro ao carregar servidor:", error);
          showMessage(
            `‚ùå Erro ao carregar servidor: ${error.message}`,
            "error"
          );
          hideVideoLoading();
        }
      }

      function switchCategory(category) {
        currentCategory = category;

        // Atualizar tabs
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelector(`[data-category="${category}"]`)
          .classList.add("active");

        // Renderizar servidores da nova categoria
        if (currentServers) {
          renderServers(currentServers, category);
        }
      }

      function getCategoryName(category) {
        const names = {
          sub: "Legendado",
          dub: "Dublado",
          raw: "RAW",
        };
        return names[category] || category;
      }

      function showLoading() {
        document.getElementById("placeholder").style.display = "flex";
        document.getElementById("placeholder").innerHTML = `
        <div class="loading-spinner"></div>
        <p>Carregando anime...</p>
      `;
      }

      function hideLoading() {
        // Loading ser√° substitu√≠do pelo conte√∫do
      }

      function showVideoLoading() {
        document.getElementById("loading").style.display = "flex";
      }

      function hideVideoLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showMessage(text, type) {
        const container = document.getElementById("message-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = text;

        container.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }

      // Atalhos de teclado
      document.addEventListener("keydown", (e) => {
        const videoPlayer = document.getElementById("video-player");

        if (e.key === " " && document.activeElement.tagName !== "BUTTON") {
          e.preventDefault();
          if (videoPlayer.paused) {
            videoPlayer.play();
          } else {
            videoPlayer.pause();
          }
        }

        // Pr√≥ximo epis√≥dio (‚Üí)
        if (e.key === "ArrowRight" && e.ctrlKey) {
          e.preventDefault();
          const currentEp = parseInt(urlParams.get("ep") || "1");
          const nextEpisode = currentEpisodes.find(
            (ep) => ep.number === currentEp + 1
          );
          if (nextEpisode) {
            selectEpisode(
              nextEpisode.episodeId,
              nextEpisode.number,
              nextEpisode.title
            );
          }
        }

        // Epis√≥dio anterior (‚Üê)
        if (e.key === "ArrowLeft" && e.ctrlKey) {
          e.preventDefault();
          const currentEp = parseInt(urlParams.get("ep") || "1");
          const prevEpisode = currentEpisodes.find(
            (ep) => ep.number === currentEp - 1
          );
          if (prevEpisode) {
            selectEpisode(
              prevEpisode.episodeId,
              prevEpisode.number,
              prevEpisode.title
            );
          }
        }
      });
    </script>

    <!-- HLS.js para suporte a streaming .m3u8 -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  </body>
</html>
