<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player Ultimate - YayaAnimes</title>

    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <!-- Plyr (Alternativo) -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #0f0f0f;
        color: white;
        font-family: "Segoe UI", Arial, sans-serif;
      }

      .header {
        background: rgba(26, 26, 46, 0.95);
        padding: 15px 30px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 24px;
        font-weight: 700;
        color: #e50914;
      }

      .back-btn {
        padding: 10px 20px;
        background: #e50914;
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }

      .player-container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
      }

      .anime-title {
        font-size: 28px;
        margin-bottom: 10px;
        color: #e50914;
      }

      .episode-info {
        font-size: 18px;
        color: #999;
        margin-bottom: 20px;
      }

      #video-container {
        position: relative;
        width: 100%;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
      }

      #video {
        width: 100%;
        max-height: 720px;
      }

      #iframe-player {
        width: 100%;
        height: 720px;
        border: none;
        border-radius: 12px;
      }

      .methods-section {
        margin-top: 30px;
        background: rgba(26, 26, 46, 0.9);
        padding: 25px;
        border-radius: 12px;
      }

      .method-btn {
        padding: 12px 24px;
        background: rgba(42, 42, 42, 0.9);
        border: 2px solid transparent;
        color: white;
        cursor: pointer;
        border-radius: 8px;
        margin: 5px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .method-btn:hover {
        border-color: #e50914;
        background: rgba(229, 9, 20, 0.2);
      }

      .method-btn.active {
        background: #e50914;
      }

      #status {
        padding: 15px 20px;
        background: rgba(26, 26, 46, 0.9);
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #e50914;
      }

      .loading {
        text-align: center;
        padding: 40px;
      }

      .spinner {
        border: 4px solid rgba(229, 9, 20, 0.1);
        border-left-color: #e50914;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo">YayaAnimes</div>
        <button onclick="window.history.back()" class="back-btn">
          ‚Üê Voltar
        </button>
      </div>
    </div>

    <div class="player-container">
      <h1 class="anime-title" id="animeTitle">Carregando...</h1>
      <p class="episode-info" id="episodeInfo">Epis√≥dio...</p>

      <div id="status">‚è≥ Carregando player...</div>

      <div id="video-container">
        <video id="video" controls></video>
        <iframe id="iframe-player" class="hidden"></iframe>
      </div>

      <div class="methods-section">
        <h3>üîß M√©todos de Reprodu√ß√£o:</h3>
        <div id="methods-buttons"></div>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="api-service.js"></script>

    <script>
      let currentEpisodeId = null;
      let currentM3U8 = null;
      let hls = null;

      // M√∫ltiplos proxies CORS
      const corsProxies = [
        "https://api.allorigins.win/raw?url=",
        "https://corsproxy.io/?",
        "https://api.codetabs.com/v1/proxy?quest=",
      ];

      // ==========================================
      // INICIALIZA√á√ÉO
      // ==========================================
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const episodeId = params.get("episodeId");
        const animeTitle = params.get("animeTitle") || "Anime";
        const episodeNumber = params.get("episodeNumber") || "1";

        console.log("üöÄ Player Ultimate Iniciado");

        if (!episodeId) {
          updateStatus("‚ùå ID do epis√≥dio n√£o fornecido", "error");
          return;
        }

        currentEpisodeId = episodeId;
        document.getElementById("animeTitle").textContent = animeTitle;
        document.getElementById(
          "episodeInfo"
        ).textContent = `Epis√≥dio ${episodeNumber}`;

        await loadAndPlay();
      });

      // ==========================================
      // CARREGAR E REPRODUZIR
      // ==========================================
      async function loadAndPlay() {
        updateStatus("üîç Buscando link de streaming...");

        try {
          // Buscar link M3U8
          const response = await window.AnimeAPI.getStreamingLinks(
            currentEpisodeId,
            "hd-1",
            "sub"
          );

          if (
            !response.success ||
            !response.data ||
            !response.data.sources ||
            response.data.sources.length === 0
          ) {
            throw new Error("Link n√£o dispon√≠vel");
          }

          // Extrair URL original (sem proxy)
          let m3u8Url = response.data.sources[0].url;

          // Se vier com proxy, extrair URL original
          if (m3u8Url.includes("proxy?url=")) {
            const urlMatch = m3u8Url.match(/url=([^&]+)/);
            if (urlMatch) {
              m3u8Url = decodeURIComponent(urlMatch[1]);
            }
          }

          currentM3U8 = m3u8Url;
          console.log("üé• M3U8 URL:", m3u8Url);

          // Criar bot√µes de m√©todos
          createMethodButtons();

          // Tentar m√©todo 1 automaticamente
          await tryMethod1();
        } catch (error) {
          console.error("‚ùå Erro:", error);
          updateStatus(
            "‚ùå Erro ao buscar streaming. Tente outro m√©todo.",
            "error"
          );
        }
      }

      // ==========================================
      // CRIAR BOT√ïES DE M√âTODOS
      // ==========================================
      function createMethodButtons() {
        const container = document.getElementById("methods-buttons");

        const methods = [
          { id: 1, name: "üé¨ M√©todo 1: HLS Direto" },
          { id: 2, name: "üîÑ M√©todo 2: Proxy CORS" },
          { id: 3, name: "üåê M√©todo 3: Iframe Embed" },
          { id: 4, name: "üì∫ M√©todo 4: Plyr Player" },
          { id: 5, name: "üéØ M√©todo 5: AllOrigins" },
        ];

        methods.forEach((method) => {
          const btn = document.createElement("button");
          btn.className = "method-btn";
          btn.textContent = method.name;
          btn.onclick = () => tryMethod(method.id);
          container.appendChild(btn);
        });
      }

      // ==========================================
      // TENTAR M√âTODO
      // ==========================================
      async function tryMethod(methodId) {
        console.log(`üîß Tentando m√©todo ${methodId}`);

        // Limpar player anterior
        if (hls) {
          hls.destroy();
          hls = null;
        }

        const video = document.getElementById("video");
        const iframe = document.getElementById("iframe-player");

        video.classList.remove("hidden");
        iframe.classList.add("hidden");

        switch (methodId) {
          case 1:
            await tryMethod1();
            break;
          case 2:
            await tryMethod2();
            break;
          case 3:
            await tryMethod3();
            break;
          case 4:
            await tryMethod4();
            break;
          case 5:
            await tryMethod5();
            break;
        }
      }

      // ==========================================
      // M√âTODO 1: HLS DIRETO
      // ==========================================
      async function tryMethod1() {
        updateStatus("üé¨ M√©todo 1: Tentando HLS direto...");

        const video = document.getElementById("video");

        if (Hls.isSupported()) {
          hls = new Hls({
            xhrSetup: (xhr, url) => {
              xhr.setRequestHeader("Origin", "https://hianime.to");
              xhr.setRequestHeader("Referer", "https://hianime.to/");
            },
          });

          hls.loadSource(currentM3U8);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            updateStatus("‚úÖ V√≠deo carregado! (M√©todo 1)", "success");
            video.play().catch((e) => console.log("Autoplay bloqueado"));
          });

          hls.on(Hls.Events.ERROR, (event, data) => {
            if (data.fatal) {
              console.error("Erro HLS:", data);
              updateStatus("‚ùå M√©todo 1 falhou. Tentando m√©todo 2...", "error");
              setTimeout(() => tryMethod2(), 1000);
            }
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = currentM3U8;
          video.addEventListener("loadedmetadata", () => {
            updateStatus("‚úÖ V√≠deo carregado! (Safari)", "success");
            video.play();
          });
        }
      }

      // ==========================================
      // M√âTODO 2: PROXY CORS
      // ==========================================
      async function tryMethod2() {
        updateStatus("üîÑ M√©todo 2: Tentando com proxy CORS...");

        for (let i = 0; i < corsProxies.length; i++) {
          const proxy = corsProxies[i];
          const proxiedUrl = proxy + encodeURIComponent(currentM3U8);

          console.log(`Tentando proxy ${i + 1}:`, proxy);

          try {
            const video = document.getElementById("video");

            if (Hls.isSupported()) {
              hls = new Hls();
              hls.loadSource(proxiedUrl);
              hls.attachMedia(video);

              // Aguardar resultado
              await new Promise((resolve, reject) => {
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                  updateStatus(`‚úÖ Sucesso com proxy ${i + 1}!`, "success");
                  video.play();
                  resolve();
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                  if (data.fatal) {
                    reject(data);
                  }
                });

                setTimeout(() => reject("Timeout"), 5000);
              });

              return; // Sucesso!
            }
          } catch (error) {
            console.warn(`Proxy ${i + 1} falhou:`, error);
            if (hls) hls.destroy();
            continue;
          }
        }

        updateStatus(
          "‚ùå Todos os proxies falharam. Tentando m√©todo 3...",
          "error"
        );
        setTimeout(() => tryMethod3(), 1000);
      }

      // ==========================================
      // M√âTODO 3: IFRAME EMBED
      // ==========================================
      async function tryMethod3() {
        updateStatus("üåê M√©todo 3: Iframe Embed...");

        const video = document.getElementById("video");
        const iframe = document.getElementById("iframe-player");

        video.classList.add("hidden");
        iframe.classList.remove("hidden");

        // HTML do player
        const iframeHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"><\/script>
          <style>
            body { margin: 0; background: #000; }
            video { width: 100%; height: 100vh; }
          </style>
        </head>
        <body>
          <video id="video" controls autoplay></video>
          <script>
            const video = document.getElementById('video');
            const hls = new Hls();
            hls.loadSource('${currentM3U8}');
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
              video.play();
              window.parent.postMessage({type:'loaded'}, '*');
            });
          <\/script>
        </body>
        </html>
      `;

        iframe.srcdoc = iframeHTML;
        updateStatus("‚úÖ Iframe carregado!", "success");
      }

      // ==========================================
      // M√âTODO 4: PLYR PLAYER
      // ==========================================
      async function tryMethod4() {
        updateStatus("üì∫ M√©todo 4: Plyr Player...");

        const video = document.getElementById("video");

        const player = new Plyr(video, {
          controls: [
            "play-large",
            "play",
            "progress",
            "current-time",
            "mute",
            "volume",
            "fullscreen",
          ],
        });

        if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(currentM3U8);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            updateStatus("‚úÖ Plyr carregado!", "success");
            player.play();
          });
        }
      }

      // ==========================================
      // M√âTODO 5: ALLORIGINS
      // ==========================================
      async function tryMethod5() {
        updateStatus("üéØ M√©todo 5: AllOrigins Proxy...");

        const proxiedUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(
          currentM3U8
        )}`;
        const video = document.getElementById("video");

        if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(proxiedUrl);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            updateStatus("‚úÖ AllOrigins funcionou!", "success");
            video.play();
          });

          hls.on(Hls.Events.ERROR, () => {
            updateStatus("‚ùå AllOrigins falhou", "error");
          });
        }
      }

      // ==========================================
      // UTILIT√ÅRIOS
      // ==========================================
      function updateStatus(message, type = "info") {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.style.borderLeftColor =
          type === "success"
            ? "#00ff00"
            : type === "error"
            ? "#ff0000"
            : "#e50914";
      }
    </script>
  </body>
</html>
